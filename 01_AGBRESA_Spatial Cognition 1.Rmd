---
title: "Appendix Final Report HyperCampus Spatial Cognition 1"
#author: "A Stahn"
#date: "10/27/2021"
#output:
 # officedown::rdocx_document
  #word_document:
    #number_sections: TRUE
    #fig_caption: TRUE
  #bookdown::html_document2:
  #number_sections: TRUE
  #fig_caption: TRUE
  #always_allow_html: true
output:  
  officedown::rdocx_document:
    tables:
      table.align: "center"
      caption:
        style: Table Caption
        pre: 'Table '
        sep: '. '
        text.align: "left"
    plots:
      align: center
      caption:
        sep: '. '
---
#install.packages("webshot")
#webshot::install_phantomjs()
```{r include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dpi = 300, echo = FALSE)
```
#Required Packages
```{r load required packages}
library(knitr) # for kable
library(readxl) # read xls
library(DT) # Print table nicely in markdown
library(reshape2) # wide to long
library(plyr) # ldply
library(tidyverse) # for fct_relevel

library(lme4) # for adding mixed model functions to plot
library(lmerTest) # for adding mixed model functions to plot
library(emmeans) # for adding mixed model marignal means and se to plot
library(qdapTools) # list_df2df(tbl_mm_fac_aov)

library(ggpubr) # for compare means, descriptives and theme_pubr
library(ggplot2)
library(ggsci)
library(scales)
library(cowplot) # for plot_grid, combine plots using cowplot
library(officedown)
library(officer)
library(flextable)
```
#Print Session Info
```{r print R and package versions, echo = FALSE}
print(sessionInfo())
```
#Functions Descritpive Stats
```{r functions for descriptive stats}
# Function to check data completion 
func_data_completion <- function(data, ...) {
  
  if(!"time.f" %in% names(data)) {
    data$time.f <- as.factor( c( rep(1, nrow(data) ) ) )
    }
  
  if(!"cond.f" %in% names(data)) {
    data$cond.f <- as.factor( c( rep(1, nrow(data) ) ) )
    }
  
  data <- reshape2::melt( data, 
                              id.vars = names( Filter(is.factor, data) )
                              )  %>%
  
  group_by(variable) %>%
  dplyr::summarise(
      N = 24 * length( levels(time.f) ) * length( levels(cond.f) ),
      n = sum( !is.na(value) ),
      Percent = n / N * 100
      )
}

# Function to compute descriptives
func_desc <- function(data, ...) {
  df_tmp <- df_demo[ , !names(df_demo) %in% c("age","height", "weight")]
  data <- merge(df_tmp, data, by = "id") #add demo
  data <- reshape2::melt( data, 
                              id.vars = names( Filter(is.factor, data) )
                              )
  groups <- enquos(...)
  
  result <- data %>%
    
    group_by(!!!groups) %>%
    
    dplyr::summarise(
      MEAN = mean(value, na.rm = T),
      SE = sd(value, na.rm = T) / sqrt(length(value) )
      )
  return(result)
}

func_bdc_correction <- function(data,..){
 df_tmp <- data %>%
    subset(time.f == bdc) %>%
    group_by(group_3, variable) %>%
    dplyr::summarise(
      mean_bdc_by_group = mean(MEAN, na.rm = T)
      )
  
  df_tmp <- merge(df_tmp, data, by = c("group_3", "variable") )
  df_tmp <- df_tmp %>%
    mutate(MEAN_corr = case_when(time.f == bdc ~
                              MEAN-mean_bdc_by_group,
                            TRUE ~ MEAN)) %>%
    select( c(!mean_bdc_by_group & !MEAN) ) %>%
    dplyr::rename(MEAN = MEAN_corr)
  }
```
#Functions Mixed Models
```{r functions for mixed models}
# Wrapper for appending bdc data as covariate
func_bdc_cov <- function(data, ...) {
  
  df_tmp <- subset(data, time.f != bdc)
  
  df_tmp_pre <- subset(data, time.f == bdc) %>%
    rename_at(vars(contains("_z")), ~ str_c("pre_", .)) %>%
    select("id" | is.numeric)
  
  df_tmp <- merge(df_tmp_pre, df_tmp, by = "id")
  droplevels(df_tmp)
  
  df_tmp <- merge(df_demo, df_tmp,by  = c("id")) 
}

# Wrapper for mixed models, takes 'dvList', requires 'model_mm', e.g., model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " * cond.f", " + (1|id)" )
func_mm_fac_with_bdc_adj_help <- function(dvList) {
  map(dvList, function(i) {
    lmerTest::lmer(paste0(i, " ~ pre_", i, model_mm),
                   REML = T,
                   data = df_tmp)
   }) %>% setNames(dvList) #add dvList names
}

# Function for creating mixed model tables, takes 'dvList'
func_tbl_aov <- function(x) {
  tbl_mm_fac_aov <- list_df2df(tbl_mm_fac_aov)
  names(tbl_mm_fac_aov)[4] <- "df1"
  names(tbl_mm_fac_aov)[5] <- "df2"
  names(tbl_mm_fac_aov)[6] <- "F"
  names(tbl_mm_fac_aov)[7] <- "P"
  tbl_mm_fac_aov[c(5:6)] <- round(tbl_mm_fac_aov[c(5:6)], digits = 2) # Round
  tbl_mm_fac_aov[c(7)] <- round(tbl_mm_fac_aov[c(7)], digits = 3) # Round
  return(tbl_mm_fac_aov)
}

# Function emmeans, takes 'dvList'; requires to define 'model', e.g., model <- c(~ time.f * group_3 * cond.f); also requires 'func_mm_fac_with_bdc_adj_help'
func_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite"))
  emm_fac_ <- lapply(emm_fac, data.frame)
  table_emm_fac_df <- ldply(emm_fac_, data.frame) #create df
  table_emm_fac_df_raw <- table_emm_fac_df
  table_emm_fac_df_raw$.id <- as.factor(as.character(table_emm_fac_df_raw$.id ))
  rm(emm_fac_)
  return(table_emm_fac_df_raw)
}

# Helper function contrasts emmeans, takes 'dvList'; also requires 'func_mm_fac_with_bdc_adj_help'
func_contrasts_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite"))
  contrasts_mm_fac <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, contrast_type,
                                                                         by = factors,
                                                                         lmer.df = "satterthwaite",
                                                                         adjust = "fdr"))
  contrasts_mm_fac <- lapply(contrasts_mm_fac, summary, infer=T) #add adj confidence intervals (adjusted if adjustment method is selected: https://cran.r-project.org/web/packages/emmeans/vignettes/confidence-intervals.html)
  contrasts_mm_fac_ <- lapply(contrasts_mm_fac, data.frame) #create df
  contrasts_mm_fac_df <- ldply(contrasts_mm_fac_, data.frame) #create df
  rm(contrasts_mm_fac_)
  return(contrasts_mm_fac_df)
}

# Function for creating table of contrasts emmeans, takes 'dvList', and requires 'func_contrasts_emm_fac_with_bdc_adj'
func_tbl_contr_emm_fac_with_bdc_adj <- function(dvList) {
  tmp <- func_contrasts_emm_fac_with_bdc_adj(dvList)
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3) #round
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$estimate," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P (FDR adj)"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"
  return(tmp)
}
```
#Functions tables
```{r functions for flextable}
theme_tableflex_report <- function(x, ...) {
  std_b <- fp_border(width = 1.5, color = "black")
  thin_b <- fp_border(width = 0.5, color = "black")
    x <- border_remove(x)
    x <- hline(x, border = thin_b, part = "all")
    x <- hline_top(x, border = std_b, part = "header")
    x <- hline_bottom(x, border = std_b, part = "header")
    x <- hline_bottom(x, border = std_b, part = "body")
    x <- bold(x = x, bold = TRUE, part = "header")
    x <- align_text_col(x, align = "left", header = TRUE)
    x <- align_nottext_col(x, align = "center", header = TRUE)
    fix_border_issues(x)
    autofit(x)
}

set_flextable_defaults(
  font.size = 10,
  font.family = "Times New Roman",
  theme_fun = theme_tableflex_report)
  #padding = 6)
  #background.color = "#EFEFEF")
```
#Themes for Plots
```{r create themes and correction factors}
# Correct ggplot2 pts and fonts
ggplot_factor_line <- ggplot2::.pt*72.27/96
ggplot_factor_font = 1.0

# Create project report theme
theme_report <- function(base_size = 8) {
  theme_pubr() + #%+replace%
    theme(
      plot.margin = margin(0, 0, 0, 0, "cm"),
      text = element_text(size = 8,
                      colour="black"), #family="Helvetica"
      # axes
      axis.title = element_text(size = 8, face = "bold"), #vjust = 0.5
      axis.text = element_text(size = 8), #angle = 0
      axis.line = element_line(size = 0.5 / ggplot_factor_line, color="black"),
      axis.ticks = element_line(size = 0.5 / ggplot_factor_line, color="black"),
      axis.ticks.length = unit(0.2, "cm"), 
      # legend
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.title = element_blank(),
      legend.text = element_text(size = 8),
      axis.title.x = element_text(size = 8),
      # facetting
      strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5),
                                          #linetype = "solid"),
          strip.text = element_text(size = 8,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(1.5, "lines")
    )
}

```
#Functions Plotting
```{r functions for plots}
# Wrapper function for line plots, forwards to func_plot_line_facet
func_plot_line <- function(x) {ggplot(x, tmpaes_plot) + 
    theme_report() +
    geom_line(position = pd,
              size = 0.3) +
    geom_errorbar(tmpaes_errorbar,
                  width =.4,
                  size = 0.3,
                  position = pd) +
    geom_point(position = pd,
               #shape = 21,
               size = 2) +
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "Time", size = 10)
    #scale_shape_manual(values=c(3, 16, 17))+
  }

# Function for line plots, takes 'desc' as input
func_plot_line_facet <- function(x) {func_plot_line(x) +
    facet_grid_def
}


# Function for bar plots, forwards to func_plot_bar_facet
func_plot_bar <- function(x) {ggplot(x, tmpaes_plot) + theme_report() +
    geom_hline(yintercept = 0,
               size = 0.3,
               linetype = "solid") +
    geom_errorbar(tmpaes_errorbar,
                 width = .4,
                  position = pd,
                  color = "black") +
    geom_bar(tmpaes_geombar, # separate by category
             stat = "identity", 
             position = pd,
             width = 1.0,
             color = "black") + # make it side-by-side
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "", size = 10) +
    guides(x = "none")
}

# Function for bar plots, takes 'desc*' as input
func_plot_bar_facet <- function(x) {func_plot_bar(x) +
    facet_grid_def
}
```
#Load Data
```{r load data}
# Demographics
df_demo <- read_excel("./Data/Data Demographics.xlsx",sheet = "Data Demo")
df_demo[c(1:5)] <- lapply(df_demo[c(1:5)], as.factor)

# SUT
df_sut <- read_excel("./Data/Data Spatial Cognition 1.xlsx", sheet = "Data SUT z")
df_sut[c(1:3)] <- lapply(df_sut[c(1:3)], as.factor)

# PTO
df_pto <- read_excel("./Data/Data Spatial Cognition 1.xlsx", sheet = "Data PTO z")
df_pto[c(1:4)] <- lapply(df_pto[c(1:4)], as.factor)

# 4MTN
df_4mtn <- read_excel("./Data/Data Spatial Cognition 1.xlsx", sheet = "Data 4MTN z")
df_4mtn[c(1:2)] <- lapply(df_4mtn[c(1:2)], as.factor)
df_4mtn <- as.data.frame(df_4mtn)

# NAVIS 2D
df_navis_2d <- read_excel("./Data/Data Spatial Cognition 1.xlsx", sheet = "Data NAVIS 2D z")
df_navis_2d[c(1:3)] <- lapply(df_navis_2d[c(1:3)], as.factor)
```
# Data Demographics
```{r descriptive summaries for demographics data}
####create summary table for demographics
#df_demo$bmi <- df_demo$weight/((df_demo$height)/100)^2 #add bmi
#df_demo$group_3 <-revalue(df_demo$group_3, c("cAG"="B cAG", "iAG"="C iAG", "CTRL"="A CTRL")) #library(plyr)
#df_demo$group_3 <- as.factor(as.character(df_demo$group_3))
library(DescTools) 
library(arsenal)

#labels(df_demo)  <- c(age = 'Age, yrs', sex = "Sex", height = "Height, cm", height = "Weight, kg", bmi = "BMI, kg/m2") #add labels
#create table
#table_desc <- summary(tableby(group_3 ~ sex + age + height + weight + bmi, data = df_demo), digits=1, digits.p=3, digits.pct=1,text=NULL,numeric.simplify=T)
#table_desc
```
# Data Completion Check
```{r descriptive summaries for completed (missing) data}
# SUT
missing_sut <- func_data_completion(df_sut)

# 4MTN
missing_4mtn <- func_data_completion(df_4mtn)

# PTO
missing_pto <- func_data_completion(df_pto)

# NAVIS 2D
missing_navis_2d <- func_data_completion(df_navis_2d)

# Combine summary
spat_bat_1_summary <- bind_rows(missing_sut[1,], 
                              missing_4mtn[1,], 
                              missing_pto[1,], 
                              missing_navis_2d[1,]) 

spat_bat_1_summary$Task <- c("Spatial Updating Task", 
                           "Four Mountain Task",
                           "Point to Origin Task",
                           "Navigation Search Task 2D")

spat_bat_1_summary <- spat_bat_1_summary[c(5,2:4)]
colnames(spat_bat_1_summary)[2] <- "Expected (N)"
colnames(spat_bat_1_summary)[3] <- "Completed (N)"
colnames(spat_bat_1_summary)[4] <- "Completed (%)"
spat_bat_1_summary <- as.data.frame(spat_bat_1_summary)
```
```{r tab.cap = "Data collection summary Spatial Cognition 1.", tab.cap.style = "Table Caption", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
spat_bat_1_summary <- spat_bat_1_summary %>% flextable() %>% autofit() %>% 
  colformat_double(j = c("Completed (%)"), digits = 1) 
# Print
spat_bat_1_summary
```
# Spatial Updating Task
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline SUT}
# Plot arithmetic means
# Compute desc
desc <- func_desc(df_sut, group_3, time.f, cond.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Drop vars
desc <- subset(desc, variable != "direction_z" & variable != "eff_z")

# Plot desc 
# New facet label names for variable
new_labels <- c("Speed","Precision")
names(new_labels) <- c("rt_z","variable_pointing_error_z")

new_labels2 <- c("Static", "Short", "Long")
names(new_labels2) <- c("0", "25", "45")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3,
                   shape = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels,
                                   cond.f = new_labels2)

facet_grid_def <- facet_grid(variable ~ cond.f,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.sut_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT2", "HDT30", "HDT59", "R+12"),
                                            variable = fct_relevel(variable, "rt_z","variable_pointing_error_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.sut_desc <- p.sut_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.sut_desc <- p.sut_desc + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model Time x Group Interaction 
```{r mixed model for time x group SUT}
# Arrange dep vars by cond.f
df_tmp <- df_sut[c(1:3,5:6)]
df_tmp <- reshape2::melt(df_tmp, id.vars = c("id","time.f","cond.f") )
df_tmp <- reshape2::dcast(df_tmp, id + time.f ~ variable + cond.f, value.var = "value" )

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp[c(16:21)])

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Time x Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed Static", blanks,"Speed Updating Short", blanks, "Speed Updating Long", blanks,
              "Precision Static", blanks,"Precision Updating Short", blanks, "Precision Updating Long", blanks)
tbl_mm_fac_aov_df_sut <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for Spatial Updating Task", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_sut <- tbl_mm_fac_aov_df_sut %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_sut
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time SUT}
# Select dep vars
dvList <- c("rt_z_25", "variable_pointing_error_z_0", "variable_pointing_error_z_25", "variable_pointing_error_z_25")

# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * 3 -1
tmp_n_cond <-  length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", 11),
                                   "Precision", rep("", 35))

tbl_contr_emm_fac_df$Condition <- c("Static", rep("", 11),
                                    "Static", rep("", 11),
                                          "Short",rep("", 11),
                                          "Long",rep("", 11))

tbl_contr_emm_fac_df$Time <- rep ( c("HDT2", rep("", tmp_n_time),
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+12", rep("", tmp_n_time)),
                                   length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_df_sut <- tbl_contr_emm_fac_df[c(8:10, 2, 7, 3:6)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Group Contrasts for Spatial Updating Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_sut <- tbl_contr_emm_fac_df_sut %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_sut
```
##Contrasts for Comparing Time Points During Bed Rest
```{r contrasts for time by groups SUT}
# Select dep vars
dvList <- c("rt_z_25")

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3 * time.f

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

  # Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * 3 -1
tmp_n_cond <-  length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", 8))

tbl_contr_emm_fac_df$Condition <- c("Short",rep("", 8))



#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_df_sut <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 3:6)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Time Contrasts for Spatial Updating Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_sut <- tbl_contr_emm_fac_df_sut %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_sut
```
<!---BLOCK_LANDSCAPE_STOP--->

##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time SUT}
# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Plot emmeans 
# New facet label names for variable
new_labels <- c("Static", "Short", "Long",
                "Static", "Short", "Long")
names(new_labels) <- c("rt_z_0", "rt_z_25", "rt_z_45",
                       "variable_pointing_error_z_0", "variable_pointing_error_z_25", "variable_pointing_error_z_45")


# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_wrap(.id ~ .,
                             #switch = "y",
                             labeller = labeller_def,
                             ncol = 3) 

# Draw plot
pd <- position_dodge(0.3)
p.sut_emmeans <- func_plot_line_facet(emm_fac %>%
                                        mutate(time.f = fct_relevel(time.f, "HDT2", "HDT30", "HDT59", "R+12"),
                                               .id = fct_relevel(.id, "rt_z_0", "rt_z_25", "rt_z_45",
                       "variable_pointing_error_z_0", "variable_pointing_error_z_25", "variable_pointing_error_z_45"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.sut_emmeans <- p.sut_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.sut_emmeans <- p.sut_emmeans + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group SUT}
# Arrange dep vars by cond.f
df_tmp <- df_sut[c(1:3,5:6)]
df_tmp <- reshape2::melt(df_tmp, id.vars = c("id","time.f","cond.f") )
df_tmp <- reshape2::dcast(df_tmp, id + time.f ~ variable + cond.f, value.var = "value" )

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp[c(16:21)])

# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+12") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed Static", blanks,"Speed Updating Short", blanks, "Speed Updating Long", blanks,
              "Precision Static", blanks,"Precision Updating Short", blanks, "Precision Updating Long", blanks)
tbl_mm_fac_aov_df_sut_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```

```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for Spatial Updating Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_sut_main <- tbl_mm_fac_aov_df_sut_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_sut_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups SUT}
# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(dvList) -1

tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", tmp_n_dvs),
                                   "Precision", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Condition <- c("Static", rep("", 1),
                                          "Short",rep("", 1),
                                          "Long",rep("", 1))

# Table for contrasts
tbl_contr_emm_fac_sut_main <- tbl_contr_emm_fac_df[c(7:8, 2, 6, 3:5)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for Spatial Updating Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_sut_main <- tbl_contr_emm_fac_sut_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_sut_main
```
##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups SUT}
# New facet label names for variable
new_labels <- c("Static", "Short", "Long",
                "Static", "Short", "Long")
names(new_labels) <- c("rt_z_0", "rt_z_25", "rt_z_45",
                       "variable_pointing_error_z_0", "variable_pointing_error_z_25", "variable_pointing_error_z_45")


# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_wrap(. ~ .id,
                             #switch = "y",
                             #scales = "free",
                             labeller = labeller_def,
                             ncol = 3) 

# Draw Plot 
pd <- position_dodge(0.99)
p.sut_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(.id = fct_relevel(.id, "rt_z_0", "rt_z_25", "rt_z_45",
                       "variable_pointing_error_z_0", "variable_pointing_error_z_25", "variable_pointing_error_z_45"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))
# Adjust legend size
p.sut_emmeans_main <- p.sut_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
##Create Combined plot 
```{r plot combined SUT}
# Combine plot 
p.sut_comb <- plot_grid(p.sut_desc, p.sut_emmeans_main + rremove("x.text") +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size = 10,
                        ncol = 2, nrow = 1,
                        rel_widths = c(2.2, 0.8))

# Adjust legend size
p.sut_comb <- p.sut_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Spatial Cognition 1/p.sut_comb.pdf",
    width = 30/2.54, 
    height = 20/2.54,
    useDingbats = FALSE) #in cm
print(p.sut_comb)
dev.off()
```
<!---BLOCK_LANDSCAPE_START---> 
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 10, fig.height = 4.7, echo = FALSE, fig.cap = "Spatial Updating Task: (a) Time course of speed and precision before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."} 
p.sut_comb
#5
```
<!---BLOCK_LANDSCAPE_STOP--->
# Point to Origin Task
##Show Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline PTO}
# Plot arithmetic means
# Pitch
# Compute desc
desc <- func_desc(df_pto, group_3, time.f, cond.f, axis, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Drop vars
desc <- subset(desc, variable != "rating_z" & variable != "direction_z" & variable != "eff_z")

desc <- subset(desc, axis == "Pitch")

# Plot desc 
# New facet label names for variable
new_labels <- c("Speed","Precision", "Distance Est.")
names(new_labels) <- c("rt_z","variable_pointing_error_z", "dist_error_z")

new_labels2 <- c("1-Turn", "2-Turn", "3-Turn")
names(new_labels2) <- c("2", "3", "5")

new_labels3 <- c("")
names(new_labels3) <- c("Pitch")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3,
                   shape = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels,
                         cond.f = new_labels2,
                         axis = new_labels3)

facet_grid_def <- facet_grid(variable ~ cond.f + axis,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.pto_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT2", "HDT30", "HDT59", "R+12"),
                                            variable = fct_relevel(variable, "rt_z", "variable_pointing_error_z", "dist_error_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.pto_desc <- p.pto_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.pto_desc_pitch <- p.pto_desc + theme(legend.key.size = unit(0.3, "cm"))

# Yaw
# Compute desc
desc <- func_desc(df_pto, group_3, time.f, cond.f, axis, variable)

# Drop vars
desc <- subset(desc, variable != "rating_z" & variable != "direction_z" & variable != "eff_z")

desc <- subset(desc, axis == "Yaw")

# Plot desc 
# New facet label names for variable
new_labels <- c("Speed","Precision", "Distance Est.")
names(new_labels) <- c("rt_z","variable_pointing_error_z", "dist_error_z")

new_labels2 <- c("1-Turn", "2-Turn", "3-Turn")
names(new_labels2) <- c("2", "3", "5")

new_labels3 <- c("")
names(new_labels3) <- c("Yaw")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels,
                         cond.f = new_labels2,
                         axis = new_labels3)

facet_grid_def <- facet_grid(variable ~ cond.f + axis,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.pto_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT2", "HDT30", "HDT59", "R+12"),
                                            variable = fct_relevel(variable, "rt_z", "variable_pointing_error_z", "dist_error_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.pto_desc <- p.pto_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.pto_desc_yaw <- p.pto_desc + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model Time x Group Interaction 
```{r mixed model for time x group PTO}
# Arrange dep vars by cond.f
df_tmp <- df_pto[c(1:4,6,8,9)]
df_tmp <- reshape2::melt(df_tmp, id.vars = c("id", "time.f", "axis", "cond.f") )
df_tmp <- reshape2::dcast(df_tmp, id + time.f + axis ~ variable + cond.f, value.var = "value" )

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp[c(23:28,20:22)])

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " * axis" ,"+ (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
    "Baseline",
    "Sex",
    "Age",
    "Time",
    "Group",
    "Axis (Pitch, Yaw)",
    "Time x Group",
    "Time x Turning Axis",
    "Group x Turning Axis",
    "Time x Group x Turning Axis"),
  length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed 1-Turn", blanks, "Speed 2-Turn", blanks, "Speed 3-Turn", blanks, "Precision 1-Turn", blanks, "Precision 2-Turn", blanks, "Precision 3-Turn", blanks, "Dist. Error 1-Turn", blanks, "Dist. Error 2-Turn", blanks, "Dist. Error 3-Turn", blanks)
tbl_mm_fac_aov_df_pto <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for Point to Origin Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_pto <- tbl_mm_fac_aov_df_pto %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_pto
```
##Contrasts for Comparing Groups at Each Time Point
```{r emmeans for groups by time PTO}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3 * axis

# Define contrasts
contrast_type <- "pairwise"
factors <- c( "time.f", "axis")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * length(levels(tbl_contr_emm_fac_df$axis)) * 3 -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * length(levels(tbl_contr_emm_fac_df$axis)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", tmp_n_dvs),
                                   "Precision", rep("", tmp_n_dvs),
                                   "Distance Est.", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Condition <- c("1-Turn", rep("", tmp_n_cond),
                                          "2-Turn",rep("", tmp_n_cond),
                                          "3-Turn",rep("", tmp_n_cond))

tbl_contr_emm_fac_df$Time <- rep ( c("HDT2", rep("", tmp_n_time),
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+12", rep("", tmp_n_time)),
                                   length(dvList) )

tbl_contr_emm_fac_df_pto <- tbl_contr_emm_fac_df[c(9:11, 2, 8, 5:7)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Group Contrasts for Point to Origin Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_pto <- tbl_contr_emm_fac_df_pto %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_pto
```
##Contrasts for Comparing Time
```{r emmeans for time by group PTO}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3 * axis

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3","axis")


# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * length(levels(tbl_contr_emm_fac_df$axis)) * 3 -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * length(levels(tbl_contr_emm_fac_df$axis)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", 53),
                                   "Precision", rep("", 53),
                                   "Distance Est.", rep("", 53))

tbl_contr_emm_fac_df$Condition <- rep (c("1-Turn", rep("", 17),
                                          "2-Turn",rep("", 17),
                                          "3-Turn",rep("", 17)),
3)

tbl_contr_emm_fac_df$Axis <- rep (c("Pitch", rep("", 8),
                                          "Yaw",rep("", 8)), 
length(dvList) )




tbl_contr_emm_fac_df_pto <- tbl_contr_emm_fac_df[c(9:11, 3, 2, 8, 5:7)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Group Contrasts for Point to Origin Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_pto <- tbl_contr_emm_fac_df_pto %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_pto
```
<!---BLOCK_LANDSCAPE_STOP--->
##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time PTO}
# Define model for emmeans
model_emmeans <- ~ time.f * group_3 * axis

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# New facet label names for variable
new_labels <- c("Speed 1-Turn","Speed 2-Turn", "Speed 3-Turn",
                "Precision 1-Turn","Precision 2-Turn","Precision 3-Turn",
                "Distance Est. 1-Turn", "Distance Est. 2-Turn", "Distance Est. 3-Turn")
names(new_labels) <- c("rt_z_2", "rt_z_3", "rt_z_5",
                       "variable_pointing_error_z_2","variable_pointing_error_z_3",
                       "variable_pointing_error_z_5",
                       "dist_error_z_2","dist_error_z_3","dist_error_z_5")

new_labels2 <- c("Pitch", "Yaw")
names(new_labels2) <- c("Pitch", "Yaw")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels,
                                   axis = new_labels2)

facet_grid_def <- facet_grid(.id ~ axis,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.pto_emmeans <- func_plot_line_facet(emm_fac %>%
                                        mutate(time.f = fct_relevel(time.f, "HDT2", "HDT30", "HDT59", "R+12"),
                                               .id = fct_relevel(.id, "rt_z_2", "rt_z_3", "rt_z_5",
                       "variable_pointing_error_z_2","variable_pointing_error_z_3",
                       "variable_pointing_error_z_5",
                       "dist_error_z_2","dist_error_z_3","dist_error_z_5"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.pto_emmeans <- p.pto_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.pto_emmeans <- p.pto_emmeans + theme(legend.key.size = unit(0.3, "cm"))

```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group PTO}
# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+12") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp[c(23:28,20:22)])

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " * axis", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group",
  "Turning Axis",
  "Group x Turning Axis"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed 1-Turn", blanks, "Speed 2-Turn", blanks, "Speed 3-Turn", blanks, "Precision 1-Turn", blanks, "Precision 2-Turn", blanks, "Precision 3-Turn", blanks, "Dist. Error 1-Turn", blanks, "Dist. Error 2-Turn", blanks, "Dist. Error 3-Turn", blanks)
tbl_mm_fac_aov_df_pto_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for Point to Origin Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_pto_main <- tbl_mm_fac_aov_df_pto_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_pto_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups PTO}
# Contrasts 
# Define model for contrasts
model_emmeans <- ~ group_3 * axis

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("axis")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * length(levels(tbl_contr_emm_fac_df$axis)) * 3 -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * length(levels(tbl_contr_emm_fac_df$axis)) -1


tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", tmp_n_dvs),
                                   "Precision", rep("", tmp_n_dvs),
                                   "Distance Est.", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Condition <- c("1-Turn", rep("", tmp_n_cond),
                                          "2-Turn",rep("", tmp_n_cond),
                                          "3-Turn",rep("", tmp_n_cond))


# Table for contrasts
tbl_contr_emm_fac_pto_main <- tbl_contr_emm_fac_df[c(8:9, 2, 7,4:6)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for Point to Origin Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_pto_main <- tbl_contr_emm_fac_pto_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_pto_main
```
##Plot Estimated Marignal Means to Compare Groups
```{r plot groups PTO}
# Pitch
# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)
emm_fac <- subset(emm_fac, axis == "Pitch")

# New facet label names for variable
new_labels <- c("1-Turn","2-Turn", "3-Turn",
                "1-Turn","2-Turn","3-Turn",
                "1-Turn", "2-Turn", "3-Turn")
names(new_labels) <- c("rt_z_2", "rt_z_3", "rt_z_5",
                       "variable_pointing_error_z_2","variable_pointing_error_z_3",
                       "variable_pointing_error_z_5",
                       "dist_error_z_2","dist_error_z_3","dist_error_z_5")

new_labels2 <- c("")
names(new_labels2) <- c("Pitch")

# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = axis,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = axis,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels,
                                   axis = new_labels2)

facet_grid_def <- facet_wrap(.id ~ axis,
                             #switch = "y",
                             #scales = "free",
                             labeller = labeller_def,
                             ncol = 3) 

# Draw Plot 
pd <- position_dodge(0.99)
p.pto_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(.id = fct_relevel(.id, "rt_z_2", "rt_z_3", "rt_z_5",
                       "variable_pointing_error_z_2","variable_pointing_error_z_3",
                       "variable_pointing_error_z_5",
                       "dist_error_z_2","dist_error_z_3","dist_error_z_5"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))


# Adjust legend size
p.pto_emmeans_main_pitch <- p.pto_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))

# Yaw
# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)
emm_fac <- subset(emm_fac, axis == "Yaw")

# New facet label names for variable
new_labels <- c("1-Turn","2-Turn", "3-Turn",
                "1-Turn","2-Turn","3-Turn",
                "1-Turn", "2-Turn", "3-Turn")
names(new_labels) <- c("rt_z_2", "rt_z_3", "rt_z_5",
                       "variable_pointing_error_z_2","variable_pointing_error_z_3",
                       "variable_pointing_error_z_5",
                       "dist_error_z_2","dist_error_z_3","dist_error_z_5")

new_labels2 <- c("")
names(new_labels2) <- c("Yaw")

# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = axis,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = axis,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels,
                                   axis = new_labels2)

facet_grid_def <- facet_wrap(axis ~ .id ,
                             #switch = "y",
                             #scales = "free",
                             labeller = labeller_def,
                             ncol = 3) 

# Draw Plot 
pd <- position_dodge(0.99)
p.pto_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(.id = fct_relevel(.id, "rt_z_2", "rt_z_3", "rt_z_5",
                       "variable_pointing_error_z_2","variable_pointing_error_z_3",
                       "variable_pointing_error_z_5",
                       "dist_error_z_2","dist_error_z_3","dist_error_z_5"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))


# Adjust legend size
p.pto_emmeans_main_yaw <- p.pto_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
###Plot Combined plot 
```{r create combined PTO}
# Combine plot Pitch
p.pto_comb_pitch <- plot_grid(p.pto_desc_pitch, p.pto_emmeans_main_pitch + rremove("x.text") + theme( strip.text.y = element_blank() ),
          labels = c("a", "b"),label_size = 10,
          ncol = 2, nrow = 1,
          rel_widths = c(2.2, 0.8))

# Adjust legend size
p.pto_comb_pitch <- p.pto_comb_pitch + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Spatial Cognition 1/p.pto_comb_pitch.pdf",
    width = 30/2.54,
    height = 20/2.54,
    useDingbats = FALSE) #in cm
print(p.pto_comb_pitch)
dev.off()

# Combine plot Yaw
p.pto_comb_yaw <- plot_grid(p.pto_desc_yaw, p.pto_emmeans_main_yaw + rremove("x.text") + theme( strip.text.y = element_blank() ),
          labels = c("a", "b"),label_size = 10,
          ncol = 2, nrow = 1,
          rel_widths = c(2.2, 0.8))

# Adjust legend size
p.pto_comb_yaw <- p.pto_comb_yaw + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Spatial Cognition 1/p.pto_comb_yaw.pdf",
    width = 30/2.54,
    height = 20/2.54,
    useDingbats = FALSE) #in cm
print(p.pto_comb_yaw)
dev.off()
```
<!---BLOCK_LANDSCAPE_START--->
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 10, fig.height = 4.7, echo = FALSE, fig.cap = "Point to Origin Task 'Pitch' Condition: (a) Time course of speed, precision, and efficiency before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.pto_comb_pitch
#8
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 10, fig.height = 4.7, echo = FALSE, fig.cap = "Point to Origin Task 'Yaw' Condition: (a) Time course of speed, and precision before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.pto_comb_yaw
```
<!---BLOCK_LANDSCAPE_STOP--->
# Navigation Search Task 2D
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline NAVIS 2D}
# Plot arithmetic means
# Compute desc
desc <- func_desc(df_navis_2d, group_3, time.f, cond.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Drop vars
desc <- subset(desc, variable != "acc_z" &
               variable != "total_target_visits_z" &
                 variable != "time_to_first_revisit_z" &
                 variable != "eff_totdistance_z" &
                 variable != "eff_totrevists_z" &
                 variable != "eff_totrevists_z" &
                 variable != "eff_acc_z")


#eff_totdistance_z
#eff_totrevists_z

# Plot desc 
# New facet label names for variable
new_labels <- c("Speed","Accuracy", "Distance")
names(new_labels) <- c("rt_z","total_revisits_z","total_distance_z")

new_labels2 <- c("Day", "Night")
names(new_labels2) <- c("Day", "Night")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3,
                   shape = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels,
                                   cond.f = new_labels2)

facet_grid_def <- facet_grid(variable ~ cond.f,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.navis_2d_desc <- func_plot_line_facet(desc %>%
                                          mutate(
                                            time.f = fct_relevel(time.f, "BDC-3", "HDT2", "HDT30", "HDT59", "R+12"),
                                            variable = fct_relevel(variable, "rt_z","total_revisits_z", "total_distance_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))
  
# Add zero line
p.navis_2d_desc <- p.navis_2d_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.navis_2d_desc <- p.navis_2d_desc + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model Time x Group Interaction 
```{r mixed model time x group NAVIS 2D}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_navis_2d)

# Select dep vars
dvList <- c("rt_z","total_revisits_z", "total_distance_z")

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " * cond.f", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Task Condition",
  "Time x Group",
  "Time x Task Condition",
  "Group x Task Condition",
  "Time x Group x Task Condition"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed", blanks, "Accuracy", blanks, "Distance", blanks) 
tbl_mm_fac_aov_df_navis_2d <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for Navigation Search Task 2D.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_navis_2d <- tbl_mm_fac_aov_df_navis_2d %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_navis_2d
```
##Contrasts for Comparing Groups at Each Time Point
```{r contrast for groups by time NAVIS 2D}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3 * cond.f

# Define contrasts
contrast_type <- "pairwise"
factors <- c("cond.f", "time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * 
  length(levels(tbl_contr_emm_fac_df$cond.f)) -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) - 1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1

Variable <- c("Speed", blanks, "Accuracy", blanks, "Distance")

tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", tmp_n_dvs),
                                   "Accuracy", rep("", tmp_n_dvs),
                                   "Distance", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Condition <- rep ( c("Day", rep("", tmp_n_cond),
                                          "Night",rep("", tmp_n_cond)),
                                        length(dvList) )

tbl_contr_emm_fac_df$Time <- rep ( c("HDT2", rep("", tmp_n_time),
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+12", rep("", tmp_n_time)),
                                   length(dvList) )
tbl_contr_emm_fac_df_navis_2d <- tbl_contr_emm_fac_df[c(9:11, 2, 8, 5:7)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Group Contrasts for Navigation Search Task 2D.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_navis_2d <- tbl_contr_emm_fac_df_navis_2d %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_navis_2d
```
##Contrasts for Comparing Groups at Each Time Point
```{r contrast for time by group NAVIS 2D}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3 * cond.f

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("cond.f", "group_3")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * 
  length(levels(tbl_contr_emm_fac_df$cond.f)) -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) - 1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1

Variable <- c("Speed", blanks, "Accuracy", blanks, "Distance")

tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", 17),
                                   "Accuracy", rep("", 17),
                                   "Distance", rep("", 17))

tbl_contr_emm_fac_df$Condition <- rep ( c("Day", rep("", 8),
                                          "Night",rep("", 8)),
                                        length(dvList) )

tbl_contr_emm_fac_df_navis_2d <- tbl_contr_emm_fac_df[c(9:10, 2, 4, 8, 5:7)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Time Contrasts for Navigation Search Task 2D.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_navis_2d <- tbl_contr_emm_fac_df_navis_2d %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_navis_2d
```
<!---BLOCK_LANDSCAPE_STOP--->
##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot groups by time NAVIS 2D}
# Define model for emmeans
model_emmeans <- ~ time.f * group_3 * cond.f

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# New facet label names for variable
new_labels <- c("Speed","Accuracy","Distance")
names(new_labels) <- c("rt_z", "total_revisits_z", "total_distance_z")

new_labels2 <- c("Day", "Night")
names(new_labels2) <- c("Day", "Night")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels,
                                   cond.f = new_labels2)

facet_grid_def <- facet_grid(.id ~ cond.f,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.navis_2d_emmeans <- func_plot_line_facet(emm_fac %>%
                                             mutate(
                                               time.f = fct_relevel(time.f, "HDT2", "HDT30", "HDT59", "R+12"),
                                               .id = fct_relevel(.id, "rt_z","total_revisits_z", "total_distance_z"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.navis_2d_emmeans <- p.navis_2d_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.navis_2d_emmeans <- p.navis_2d_emmeans + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group NAVIS 2D}
# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+12") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- c("rt_z","total_revisits_z", "total_distance_z")

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " * cond.f", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group",
  "Task Condition",
  "Group x Task Condition"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed", blanks, "Accuracy", blanks, "Distance", blanks)
tbl_mm_fac_aov_df_navis_2d_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for Navigation Search Task 2D.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_navis_2d_main <- tbl_mm_fac_aov_df_navis_2d_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_navis_2d_main
```
##Compute Contrasts for Comparing Groups
```{r contrasts for groups NAVIS 2D}
# Define model for emmeans
model_emmeans <- ~ group_3 * cond.f

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts 
# Define model for contrasts
model_emmeans <- ~ group_3 * cond.f

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("cond.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * length(levels(tbl_contr_emm_fac_df$cond.f)) -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", tmp_n_dvs),
                                   "Accuracy", rep("", tmp_n_dvs),
                                   "Distance", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Condition <- rep ( c("Day", rep("", tmp_n_cond),
                                          "Night",rep("", tmp_n_cond)),
                                        length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_navis_2d_main <- tbl_contr_emm_fac_df[c(8:9, 2, 7,4:6)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for Navigation Search Task 2D.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_navis_2d_main <- tbl_contr_emm_fac_navis_2d_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_navis_2d_main
```
##Plot Estimated Marignal Means for Group Comparisons
```{r plot groups NAVIS 2D}
# New facet label names for variable
new_labels <- c("Speed","Accuracy","Distance")
names(new_labels) <- c("rt_z", "total_revisits_z", "total_distance_z")

new_labels2 <- c("Day", "Night")
names(new_labels2) <- c("Day", "Night")

# Define aes for func_plot
tmpaes_plot <- aes(x = cond.f,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = cond.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = cond.f,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels,
                                   cond.f = new_labels2)

facet_grid_def <- facet_grid(.id ~ cond.f,
                             switch = "y",
                             scales = "free",
                             labeller = labeller_def) 

# Draw Plot 
pd <- position_dodge(0.99)
p.navis_2d_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                                 mutate(
                                                   .id = fct_relevel(.id, "rt_z","total_revisits_z", "total_distance_z"),
                                                   group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Adjust legend size
p.navis_2d_emmeans_main <- p.navis_2d_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
###Plot Combined plot 
```{r plot combined NAVIS 2D}
# Combine plot
p.navis_2d_comb <- plot_grid(p.navis_2d_desc, p.navis_2d_emmeans_main + rremove("x.text") + theme( strip.text.y = element_blank() ),
          labels = c("a", "b"),label_size = 10,
          ncol = 2, nrow = 1,
          rel_widths = c(2.2, 0.8))

# Adjust legend size
p.navis_2d_comb <- p.navis_2d_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Spatial Cognition 1/p.navis_2d_comb.pdf",
    width = 30/2.54,
    height = 20/2.54,
    useDingbats = FALSE) #in cm
print(p.navis_2d_comb)
dev.off()
```
<!---BLOCK_LANDSCAPE_START--->
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 7.2, fig.height = 4.7, echo = FALSE, fig.cap = "Navigation Search Task 2D: (a) Time course of speed, accuracy and distance traveled before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.navis_2d_comb
```
<!---BLOCK_LANDSCAPE_STOP--->
# Four Mountains Task
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline 4MTN}
# Plot arithmetic means

# Compute desc
desc <- func_desc(df_4mtn, group_3, time.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Plot desc 
# New facet label names for variable
new_labels <- c("Speed","Accuracy","Efficiency")
names(new_labels) <- c("rt_z","acc_z","eff_z")

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels,
                                   cond.f = new_labels2)

facet_grid_def <- facet_grid(~ variable,
                             switch = "y",
                             labeller = labeller_def) 

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3,
                   shape = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)
# Draw plot
pd <- position_dodge(0.3)
p.4mtn_desc <- func_plot_line_facet(desc %>%
                                      mutate(
                                        time.f = fct_relevel(time.f, "BDC-3", "HDT2", "HDT30", "HDT59", "R+12"),
                                        variable = fct_relevel(variable, "rt_z","acc_z","eff_z"),
                                        group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.4mtn_desc <- p.4mtn_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")
```
##Mixed Model Time in Bed Rest x Group Interaction 
```{r mixed model for time x group 4MTN}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_4mtn)

# Select dep vars
dvList <- c("rt_z","acc_z","eff_z")

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Time x Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed", blanks,"Accuracy", blanks, "Precision", blanks)
tbl_mm_fac_aov_df_4mtn <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for Four Mountains Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_4mtn <- tbl_mm_fac_aov_df_4mtn %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_4mtn
```
##Contrasts for Comparing Groups at Each Time Point
```{r constrasts for groups by time 4MTN}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f))  -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) - 1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1

Variable <- c("rt_z","acc_z","eff_z")

tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", tmp_n_dvs),
                                   "Accuracy", rep("", tmp_n_dvs),
                                   "Efficiency", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Time <- rep ( c("HDT2", rep("", tmp_n_time),
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+12", rep("", tmp_n_time)),
                                   length(dvList) )

# Table for contrasts
tbl_contr_emm_fac_df_4mtn <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 3:6)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Group Contrasts for Four Mountains Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_4mtn <- tbl_contr_emm_fac_df_4mtn %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_4mtn
```
<!---BLOCK_LANDSCAPE_STOP--->
##Contrasts for Comparing Groups at Each Time Point
```{r constrasts for time by group 4MTN}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f))  -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) - 1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1

Variable <- c("rt_z","acc_z","eff_z")

tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", 8),
                                   "Accuracy", rep("", 8),
                                   "Efficiency", rep("", 8))



# Table for contrasts
tbl_contr_emm_fac_df_4mtn <- tbl_contr_emm_fac_df[c(8, 3,2, 7, 4:6)]
```
<!---BLOCK_LANDSCAPE_START--->
```{r tab.cap = "Mixed Model Time Contrasts for Four Mountains Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_4mtn <- tbl_contr_emm_fac_df_4mtn %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_4mtn
```
##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot groups by time 4MTN}
# Define model for emmeans
model_emmeans <- ~ time.f * group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# New facet label names for variable
new_labels <- c("Speed","Accuracy","Efficiency")
names(new_labels) <- c("rt_z","acc_z","eff_z")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(~ .id,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.4mtn_emmeans <- func_plot_line_facet(emm_fac %>%
                                         mutate(
                                           time.f = fct_relevel(time.f, "HDT2", "HDT30", "HDT59", "R+12"),
                                           .id = fct_relevel(.id, "rt_z","acc_z","eff_z"),
                                           group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))
# Add zero line
p.4mtn_emmeans <- p.4mtn_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.4mtn_emmeans <- p.4mtn_emmeans + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r  mixed model for main effect group  4MTN}
# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+12") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- c("rt_z","acc_z","eff_z")

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Speed", blanks,"Accuracy", blanks, "Efficiency", blanks)
tbl_mm_fac_aov_df_4mtn_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for Four Mountains Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_4mtn_main <- tbl_mm_fac_aov_df_4mtn_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_4mtn_main
```
##Contrasts for Group Comparisons
```{r contrasts for groups 4MTN}
# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts 
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table

tbl_contr_emm_fac_df$Variable <- c("Speed", rep("", 1),
                                   "Accuracy", rep("", 1),
                                   "Efficiency", rep("", 1))

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_4mtn_main <- tbl_contr_emm_fac_df[c(7, 2, 6, 3:5)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for Four Mountains Task.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_4mtn_main <- tbl_contr_emm_fac_4mtn_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (FDR adj)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_4mtn_main
```
##Plot Estimated Marignal Means for Group Comparisons
```{r plot groups 4MTN}
# New facet label names for variable
new_labels <- c("Speed","Accuracy","Efficiency")
names(new_labels) <- c("rt_z","acc_z","eff_z")

# Define aes for func_plot
tmpaes_plot <- aes(x = group_3, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(~ .id,
                             switch = "y",
                             labeller = labeller_def) 
# Draw plot
pd <- position_dodge(1.5)
p.4mtn_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                             mutate(
                                               .id = fct_relevel(.id, "rt_z","acc_z","eff_z"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Adjust legend size
p.4mtn_emmeans_main <- p.4mtn_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
##Plot Combined plot 
```{r plot combined 4MTN}
# Combine plot
p.4mtn_comb <- plot_grid(p.4mtn_desc, p.4mtn_emmeans_main + rremove("x.text") + theme( strip.text.y = element_blank() ),
          labels = c("a", "b"),label_size = 10,
          ncol = 2, nrow = 1,
          rel_widths = c(2.2, 0.8))

# Adjust legend size
p.4mtn_comb <- p.4mtn_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Spatial Cognition 1/p.4mtn_comb.pdf",
    width = 30/2.54,
    height = 20/2.54,
    useDingbats = FALSE) #in cm
print(p.4mtn_comb)
dev.off()
```
<!---BLOCK_LANDSCAPE_START--->
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 10, fig.height = 3.0, echo = FALSE, fig.cap = "Four Mountains Task: (a) Time course of speed, precision, and efficiency before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.4mtn_comb
```
<!---BLOCK_LANDSCAPE_STOP--->