---
title: "Appendix Final Report HyperCampus MRI"
#author: "A Stahn"
#date: "10/27/2021"
#output:
 # officedown::rdocx_document
  #word_document:
    #number_sections: TRUE
    #fig_caption: TRUE
  #bookdown::html_document2:
  #number_sections: TRUE
  #fig_caption: TRUE
  #always_allow_html: true
output:  
  officedown::rdocx_document:
    tables:
      table.align: "left"
      caption:
        style: Table Caption
        pre: 'Table '
        sep: '. '
        text.align: "left"
    plots:
      align: left
      caption:
        sep: '. '
---
#Required Packages
```{r load required packages, message = FALSE, include = FALSE}
library(knitr) # for kable
library(readxl) # read xls
library(DT) # Print table nicely in markdown
library(reshape2) # wide to long
library(plyr) # ldply
library(tidyverse) # for fct_relevel
library(dplyr) #regress out?
library(tidyr) #regress out?
library(broom) #regress out?

library(lme4) # for adding mixed model functions to plot
library(lmerTest) # for adding mixed model functions to plot
library(emmeans) # for adding mixed model marignal means and se to plot
library(qdapTools) # list_df2df(tbl_mm_fac_aov)

library(ggpubr) # for compare means, descriptives and theme_pubr
library(ggplot2)
library(ggsci)
library(scales)
library(cowplot) # for plot_grid, combine plots using cowplot
library(officedown)
library(officer)
library(flextable)
```
#Print Session Info
```{r print R and package versions, include = FALSE}
print(sessionInfo())
```
```{r include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dpi = 300, echo = FALSE)
```
##Load Data
```{r load data}
# Demographics
df_demo <- read_excel("./Data/Data Demographics.xlsx",sheet = "Data Demo")
df_demo[c(1:5)] <- lapply(df_demo[c(1:5)], as.factor)

# vbm
df_vbm <- read_excel("./Data/Data MRI.xlsx", sheet = "VBM z")
df_vbm[c(1:2)] <- lapply(df_vbm[c(1:2)], as.factor)

df_vbm_wb <- read_excel("./Data/Data MRI.xlsx", sheet = "VBM_bdc_hft59 z")
df_vbm_wb[c(1:2)] <- lapply(df_vbm_wb[c(1:2)], as.factor)

# hc
df_hc <- read_excel("./Data/Data MRI.xlsx", sheet = "HC UPenn z")
df_hc[c(1:2)] <- lapply(df_hc[c(1:2)], as.factor)

# mtr
df_mtr <- read_excel("./Data/Data MRI.xlsx", sheet = "MTR z")
df_mtr[c(1:2)] <- lapply(df_mtr[c(1:2)], as.factor)

# lc
df_lc <- read_excel("./Data/Data MRI.xlsx", sheet = "High Res LC z")
df_lc[c(1:2)] <- lapply(df_lc[c(1:2)], as.factor)

# rsfrmi AGvCTRL_BDC_HDT59
df_rsfrmi_AGvCTRL_BDC_HDT59 <- read_excel("./Data/Data MRI.xlsx", sheet = "rsfrmi AGvCTRL_BDC_HDT59 z")
df_rsfrmi_AGvCTRL_BDC_HDT59[c(1:2)] <- lapply(df_rsfrmi_AGvCTRL_BDC_HDT59[c(1:2)], as.factor)

# rsfrmi cAGvsCTRL_BDC_HDT59
df_rsfrmi_cAGvsCTRL_BDC_HDT59 <- read_excel("./Data/Data MRI.xlsx", sheet = "rsfrmi cAGvsCTRL_BDC_HDT59 z")
df_rsfrmi_cAGvsCTRL_BDC_HDT59[c(1:2)] <- lapply(df_rsfrmi_cAGvsCTRL_BDC_HDT59[c(1:2)], as.factor)

# rsfrmi Seed
df_rsfrmi_l_iAG_hc_bdc_hdt59 <- read_excel("./Data/Data MRI.xlsx", sheet = "rsfmri Seed l_HC BDC_HDT59 z")
df_rsfrmi_l_iAG_hc_bdc_hdt59[c(1:2)] <- lapply(df_rsfrmi_l_iAG_hc_bdc_hdt59[c(1:2)], as.factor)

# task frmi Pattern Separation
df_patsep <- read_excel("./Data/Data MRI.xlsx", sheet = "task fmri PatSep z")
df_patsep[c(1:3)] <- lapply(df_patsep[c(1:3)], as.factor)
names(df_patsep)[names(df_patsep) == "type"] <- "cond.f"
```
##Descriptive Functions
```{r functions for descriptive stats}
# Function to check data completion 
func_data_completion <- function(data, ...) {
  
  if(!"time.f" %in% names(data)) {
    data$time.f <- as.factor( c( rep(1, nrow(data) ) ) )
    }
  
  if(!"cond.f" %in% names(data)) {
    data$cond.f <- as.factor( c( rep(1, nrow(data) ) ) )
    }
  
  data <- reshape2::melt( data, 
                              id.vars = names( Filter(is.factor, data) )
                              )  %>%
  
  group_by(variable) %>%
  dplyr::summarise(
      N = 24 * length( levels(time.f) ) * length( levels(cond.f) ),
      n = sum( !is.na(value) ),
      Percent = n / N * 100
      )
}

# Function to compute descriptives
func_desc <- function(data, ...) {
  df_tmp <- df_demo[ , !names(df_demo) %in% c("age","height", "weight")]
  data <- merge(df_tmp, data, by = "id") #add demo
  data <- reshape2::melt( data, 
                              id.vars = names( Filter(is.factor, data) )
                              )
  groups <- enquos(...)
  
  result <- data %>%
    
    group_by(!!!groups) %>%
    
    dplyr::summarise(
      MEAN = mean(value, na.rm = T),
      SE = sd(value, na.rm = T) / sqrt(length(value) )
      )
  return(result)
}

func_bdc_correction <- function(data,..){
 df_tmp <- data %>%
    subset(time.f == bdc) %>%
    group_by(group_3, variable) %>%
    dplyr::summarise(
      mean_bdc_by_group = mean(MEAN, na.rm = T)
      )
  
  df_tmp <- merge(df_tmp, data, by = c("group_3", "variable") )
  df_tmp <- df_tmp %>%
    mutate(MEAN_corr = case_when(time.f == bdc ~
                              MEAN-mean_bdc_by_group,
                            TRUE ~ MEAN)) %>%
    select( c(!mean_bdc_by_group & !MEAN) ) %>%
    dplyr::rename(MEAN = MEAN_corr)
}

##regress out age by variable
##regress out age by variable
func_age_sex_cor <- function(data,...){
  data_reg <- merge(data, df_demo[c(1,3,5,6)], by ="id")
  data_reg <- melt(data_reg, id.var = id_var)
  data_reg$sex <- as.numeric(data_reg$sex)
  # Adjust for Age and sex
  data_coef <- data_reg %>%
    group_by(variable) %>% 
    do(tidy(lm(value ~ age +sex, .))) %>%
    filter(term != "(Intercept)") %>%
    group_by(variable)
  data_coef$term <- as.factor(data_coef$term)
  data_coef <- dcast(data_coef[-c(4:6)],  variable ~term, value.var = "estimate")
  data_coef <- data_coef %>%
    mutate(beta_age = age,
           beta_sex = sex)
  data_coef <- data_coef[-c(2,3)]
  data_cor <- merge(data_reg, data_coef, by=c("variable"))
  data_cor$mean_age <- mean(data_cor$age, na.rm=T)
  data_cor$mean_sex <- mean(data_cor$sex, na.rm=T)
  data_cor$value_adj_age_sex <- data_cor$value - ( data_cor$beta_age * (data_cor$age - data_cor$mean_age) ) - ( data_cor$beta_sex * (data_cor$sex - data_cor$mean_sex) )
  # Clean
  data_cor <- subset(data_cor, select = c(data_select) )
  data_cor <- dcast(data_cor, id_var_cast, value.var = "value_adj_age_sex")
  return(data_cor)
}

func_age_sex_cor_org <- function(data,...){
  data_reg <- merge(data, df_demo[c(1,3,5,6)], by ="id")
  data_reg <- melt(data_reg, id.var = id_var)
  data_reg$sex <- as.numeric(data_reg$sex)
  
  # Adjust for Age
  data_coef <- data_reg %>%
    group_by(variable) %>% 
    do(tidy(lm(value ~ age, .))) %>%
    filter(term == "age") %>%
    mutate(beta_age = estimate) %>%
    as.data.frame()
  data_coef <- data_coef[c(1,7)]
  data_cor <- merge(data_reg, data_coef, by=c("variable"))
  data_cor$mean_age <- mean(data_cor$age, na.rm=T)
  data_cor$value_adj_age <- data_cor$value - (data_cor$beta_age * (data_cor$age - data_cor$mean_age))
  
  # Adjust for Sex
  data_coef <- data_cor %>%
    group_by(variable) %>% 
    do(tidy(lm(value_adj_age ~ sex, .))) %>% 
    filter(term == "sex") %>% 
    mutate(beta_sex = estimate) %>%
    as.data.frame()
  data_coef <- data_coef[c(1,7)]
  data_cor <- merge(data_cor, data_coef, by=c("variable"))
  data_cor$mean_sex <- mean(data_cor$sex, na.rm =T)
  data_cor$value_adj_age_sex <- data_cor$value_adj_age - (data_cor$beta_sex * (data_cor$sex - data_cor$sex))
  
  # Clean
  data_cor <- subset(data_cor, select = c(data_select) )
  #data_cor <- data_cor[c(2,1,3,4,14)]
  data_cor <- dcast(data_cor, id_var_cast, value.var = "value_adj_age_sex")
  return(data_cor)
}
```

##Functions for Mixed Models
```{r functions for mixed models}
# Mixed Model no bdc adj
func_mm_fac_help <- function(dvList) {
  map(dvList, function(i) {
    lmerTest::lmer(paste0(i, " ~ ", model_mm),
                   REML = T,
                   data = df_tmp)
   }) %>% setNames(dvList) #add dvList names
}

# Function emmeans, takes 'dvList'; requires to define 'model', e.g., model <- c(~ time.f * group_3 * cond.f); also requires 'func_mm_fac_with_bdc_adj_help'
func_emm_fac <- function(x) {
  mm_fac <- func_mm_fac_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells"))
  emm_fac_ <- lapply(emm_fac, data.frame)
  table_emm_fac_df <- ldply(emm_fac_, data.frame) #create df
  table_emm_fac_df_raw <- table_emm_fac_df
  table_emm_fac_df_raw$.id <- as.factor(as.character(table_emm_fac_df_raw$.id ))
  rm(emm_fac_)
  return(table_emm_fac_df_raw)
}

# Helper function contrasts emmeans, takes 'dvList'; also requires 'func_mm_fac_with_bdc_adj_help'
func_contrasts_emm_fac <- function(x) {
  mm_fac <- func_mm_fac_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells"))
  contrasts_mm_fac <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, contrast_type,
                                                                         by = factors,
                                                                         lmer.df = "satterthwaite",
                                                                         adjust = "fdr"))
  contrasts_mm_fac <- lapply(contrasts_mm_fac, summary, infer=T) #add adj confidence intervals (adjusted if adjustment method is selected: https://cran.r-project.org/web/packages/emmeans/vignettes/confidence-intervals.html)
  contrasts_mm_fac_ <- lapply(contrasts_mm_fac, data.frame) #create df
  contrasts_mm_fac_df <- ldply(contrasts_mm_fac_, data.frame) #create df
  rm(contrasts_mm_fac_)
  return(contrasts_mm_fac_df)
}

# Function for creating table of contrasts emmeans, takes 'dvList', and requires 'func_contrasts_emm_fac_with_bdc_adj'
func_tbl_contr_emm_fac <- function(dvList) {
  tmp <- func_contrasts_emm_fac(dvList)
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3) #round
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$estimate," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P FDR adj"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"
  return(tmp)
}
# Wrapper for mixed models, takes 'dvList', requires 'model_mm', e.g., model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " * cond.f", " + (1|id)" )
# Function for creating mixed model tables, takes 'dvList'
func_tbl_aov <- function(x) {
  tbl_mm_fac_aov <- list_df2df(tbl_mm_fac_aov)
  names(tbl_mm_fac_aov)[4] <- "df1"
  names(tbl_mm_fac_aov)[5] <- "df2"
  names(tbl_mm_fac_aov)[6] <- "F"
  names(tbl_mm_fac_aov)[7] <- "P"
  tbl_mm_fac_aov[c(5:6)] <- round(tbl_mm_fac_aov[c(5:6)], digits = 2) # Round
  tbl_mm_fac_aov[c(7)] <- round(tbl_mm_fac_aov[c(7)], digits = 3) # Round
  return(tbl_mm_fac_aov)
}

# Wrapper for appending bdc data as covariate
func_bdc_cov <- function(data, ...) {
  
  df_tmp <- subset(data, time.f != bdc)
  
  df_tmp_pre <- subset(data, time.f == bdc) %>%
    rename_at(vars(contains("_z")), ~ str_c("pre_", .)) %>%
    select("id" | where(is.numeric) )
  
  df_tmp <- merge(df_tmp_pre, df_tmp, by = "id")
  droplevels(df_tmp)
  
  df_tmp <- merge(df_demo, df_tmp,by  = c("id")) 
}

# Mixed model function with bdc adj
func_mm_fac_with_bdc_adj_help <- function(dvList) {
  map(dvList, function(i) {
    lmerTest::lmer(paste0(i, " ~ pre_", i, model_mm),
                   REML = T,
                   data = df_tmp)
   }) %>% setNames(dvList) #add dvList names
}


# Function emmeans, takes 'dvList'; requires to define 'model', e.g., model <- c(~ time.f * group_3 * cond.f); also requires 'func_mm_fac_with_bdc_adj_help'
func_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells"))
  emm_fac_ <- lapply(emm_fac, data.frame)
  table_emm_fac_df <- ldply(emm_fac_, data.frame) #create df
  table_emm_fac_df_raw <- table_emm_fac_df
  table_emm_fac_df_raw$.id <- as.factor(as.character(table_emm_fac_df_raw$.id ))
  rm(emm_fac_)
  return(table_emm_fac_df_raw)
}

# Helper function contrasts emmeans, takes 'dvList'; also requires 'func_mm_fac_with_bdc_adj_help'
func_contrasts_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells"))
  contrasts_mm_fac <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, contrast_type,
                                                                         by = factors,
                                                                         lmer.df = "satterthwaite",
                                                                         adjust = "fdr"))
  contrasts_mm_fac <- lapply(contrasts_mm_fac, summary, infer=T) #add adj confidence intervals (adjusted if adjustment method is selected: https://cran.r-project.org/web/packages/emmeans/vignettes/confidence-intervals.html)
  contrasts_mm_fac_ <- lapply(contrasts_mm_fac, data.frame) #create df
  contrasts_mm_fac_df <- ldply(contrasts_mm_fac_, data.frame) #create df
  rm(contrasts_mm_fac_)
  return(contrasts_mm_fac_df)
}

# Function for creating table of contrasts emmeans, takes 'dvList', and requires 'func_contrasts_emm_fac_with_bdc_adj'
func_tbl_contr_emm_fac_with_bdc_adj <- function(dvList) {
  tmp <- func_contrasts_emm_fac_with_bdc_adj(dvList)
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3) #round
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$estimate," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P FDR adj"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"
  return(tmp)
}

# P values for time paramweter estimates vs baseline ('zero')
func_p_values_contrasts_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(x)
  emm_fac_contrasts_p <- lapply( mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells", infer=T) )
  emm_fac_contrasts_p_ <- lapply(emm_fac_contrasts_p, data.frame) #create df
  emm_fac_contrasts_p <- ldply(emm_fac_contrasts_p_, data.frame) #create df
  return(emm_fac_contrasts_p)
}

func_tbl_contr_emm_fac_p_values <- function(dvList) {
  tmp <- func_p_values_contrasts_emm_fac_with_bdc_adj(dvList)
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3)
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$emmean," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P FDR adj"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"
  return(tmp)
}

```
#Functions tables
```{r functions for flextable}
theme_tableflex_report <- function(x, ...) {
  std_b <- fp_border(width = 1.5, color = "black")
  thin_b <- fp_border(width = 0.5, color = "black")
    x <- border_remove(x)
    x <- hline(x, border = thin_b, part = "all")
    x <- hline_top(x, border = std_b, part = "header")
    x <- hline_bottom(x, border = std_b, part = "header")
    x <- hline_bottom(x, border = std_b, part = "body")
    x <- bold(x = x, bold = TRUE, part = "header")
    x <- align_text_col(x, align = "left", header = TRUE)
    x <- align_nottext_col(x, align = "center", header = TRUE)
    fix_border_issues(x)
    autofit(x)
}

set_flextable_defaults(
  font.size = 10,
  font.family = "Times New Roman",
  theme_fun = theme_tableflex_report)
  #padding = 6)
  #background.color = "#EFEFEF")
```
#Themes for Plots
```{r create themes and correction factors, include = FALSE}
# Correct ggplot2 pts and fonts
ggplot_factor_line <- ggplot2::.pt*72.27/96
ggplot_factor_font = 1.0

# Create project report theme
theme_report <- function(base_size = 8) {
  theme_pubr() + #%+replace%
    theme(
      plot.margin = margin(0, 0, 0, 0, "cm"),
      text = element_text(size = 8,
                      colour="black"), #family="Helvetica"
      # axes
      axis.title = element_text(size = 8, face = "bold"), #vjust = 0.5
      axis.text = element_text(size = 8), #angle = 0
      axis.line = element_line(size = 0.5 / ggplot_factor_line, color="black"),
      axis.ticks = element_line(size = 0.5 / ggplot_factor_line, color="black"),
      axis.ticks.length = unit(0.2, "cm"), 
      # legend
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.title = element_blank(),
      legend.text = element_text(size = 8),
      axis.title.x = element_text(size = 8),
      # facetting
      strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5),
                                          #linetype = "solid"),
          strip.text = element_text(size = 8,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(1.5, "lines")
    )
}

```
#Plot Functions
```{r functions for plots}
# Wrapper function for line plots, forwards to func_plot_line_facet
func_plot_line <- function(x) {ggplot(x, tmpaes_plot) + 
    theme_report() +
    geom_line(position = pd) +
    geom_errorbar(tmpaes_errorbar,
                  width =.4, 
                  position = pd) +
    geom_point(position = pd,
               shape = 21,
               size = 2) + #shape = 21, size = 1, fill = "white"
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "Time", size = 10) +
    theme(legend.title = element_blank(),
          legend.text = element_text(size = 8),
          axis.title.x = element_text(size = 10))
  }

# Function for line plots, takes 'desc' as input
func_plot_line_facet <- function(x) {func_plot_line(x) +
    facet_grid_def +
    theme(strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5,
                                          linetype = "solid"),
          strip.text = element_text(size = 10,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(2, "lines"))
}

# Function for bar plots, forwards to func_plot_bar_facet
func_plot_bar <- function(x) {ggplot(x, tmpaes_plot) + theme_report() +
    geom_hline(yintercept = 0,
               size = 0.3,
               linetype = "solid") +
    geom_errorbar(tmpaes_errorbar,
                 width = .4,
                  position = pd,
                  color = "black") +
    geom_bar(tmpaes_geombar, # separate by category
             stat = "identity", 
             position = pd,
             width = 1.0,
             color = "black") + # make it side-by-side
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "", size = 10) +
    guides(x = "none") +
    theme(legend.title = element_blank(),
          legend.text = element_text(size=8),
          axis.title.x = element_text(size = 10),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
}


# Function for bar plots, takes 'desc*' as input
func_plot_bar_facet <- function(x) {func_plot_bar(x) +
    facet_grid_def +
    theme(strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5,
                                          linetype = "solid"),
          strip.text = element_text(size = 10,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(2, "lines"))
}

# Function for bar plots, forwards to func_plot_bar_facet
func_plot_bar_singlevar <- function(x) {ggplot(x, tmpaes_plot) + theme_report() +
    geom_hline(yintercept = 0,
               size = 0.3,
               linetype = "solid") +
    geom_errorbar(tmpaes_errorbar,
                  width = .3,
                  size = 0.3,
                  position = pd,
                  color = "black") +
    geom_bar(tmpaes_geombar, # separate by category
             stat = "identity", 
             position = pd,
             width = 1.0,
             size = 0.3,
             color = "black") + # make it side-by-side
    scale_y_continuous(expand = c(0,0)) +
    #labs(y = "", x = "", size = 10) +
    #guides(x = "none") +
    theme(legend.title = element_blank(),
          legend.text = element_text(size = 8),
          axis.title.x = element_text(size = 10),
          axis.title.y = element_text(size = 10))
          #axis.text.x = element_blank(),
          #axis.ticks.x = element_blank())
}
```
# Data Completion Check
```{r descriptive summaries for completed (missing) data}
# vbm
missing_vbm <- func_data_completion(df_vbm)

# hc
missing_hc <- func_data_completion(df_hc)

# mtr
missing_mtr <- func_data_completion(df_mtr)

# lc
missing_lc <- func_data_completion(df_lc)

# rsfmri
missing_rsfrmi <- func_data_completion(df_rsfrmi_AGvCTRL_BDC_HDT59)

# rsfmri
missing_taskfmri <- func_data_completion(df_patsep)

# Combine summary
mri_summary <- bind_rows(missing_vbm[1,], 
                              missing_hc[1,], 
                              missing_mtr[1,], 
                              missing_lc[1,],
                              missing_rsfrmi[1,],
                              missing_taskfmri[1,]) 

mri_summary$Sequence <- c("Whole-brain VBM", 
                           "High Res Hippocampus",
                           "Magnerization Transfer Ratio",
                           "High Res Locus Coeruleus",
                          "Resting State fMRI",
                          "Task fMRI Pattern Separation")

mri_summary <- mri_summary[c(5,2:4)]
colnames(mri_summary)[2] <- "Expected (N)"
colnames(mri_summary)[3] <- "Completed (N)"
colnames(mri_summary)[4] <- "Completed (%)"
mri_summary <- as.data.frame(mri_summary)
```
```{r tab.cap = "Data collection summary MRI.", tab.cap.style = "Table Caption", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
mri_summary <- mri_summary %>% flextable() %>% autofit() %>% 
  colformat_double(j = c("Completed (%)"), digits = 1) 
# Print
mri_summary
```
# VBM BDC Whole-Brain
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline vbm whole-brain}
# Compute Mean across ROIs
df_vbm_wb_sum <- df_vbm_wb %>%
  group_by(id, time.f) %>%
  dplyr::summarise(
    wb_increase_z = post_min_pre_roi1_z + post_min_pre_roi2_z + post_min_pre_roi3_z + post_min_pre_roi4_z + post_min_pre_roi5_z + post_min_pre_roi6_z + post_min_pre_roi7_z,
    wb_decrease_z = pre_min_post_roi1_z + pre_min_post_roi2_z + pre_min_post_roi3_z + pre_min_post_roi4_z + pre_min_post_roi5_z + pre_min_post_roi6_z + pre_min_post_roi7_z + pre_min_post_roi8_z
    )
id <- rep(48:24, each=4)
group=rep(c("A","B","C"),each=4)
group = rep(group, 8)
dat <- cbind(id, group)
dat <- dat[-c(97:100),]
dat <- cbind(data_cor,dat)
dat$age <- dat$age*1.3
dat <- dat[c(8,9,2,5:7,3,4)]
dat <- dat[-c(4)]
colnames(dat)[6] <- "y_1"
colnames(dat)[7] <- "y_2"
dat <- melt(dat, id.var = c("id", "time.f", "sex", "age", "group"))
library(openxlsx) # save tables
write.xlsx(dat, file = "./Data/Stahn_regressout.csv", overwrite = TRUE)

# Add baseline as cov
func_bdc_cov_desc <- function(data, ...) {
  #data_cor <- merge(df_vbm_wb_sum, df_demo[c(1,3,5,6)], by ="id")
  data_cor <- melt(df_vbm_wb_sum, id.var = c("id", "time.f"))
  #df_tmp <- subset(df_vbm_wb_sum, time.f != bdc)
  
  data_cor_pre <- subset(data_cor, time.f == bdc)
  colnames(data_cor_pre)[4] <- "pre"
    #rename_at(vars(contains("_z")), ~ str_c("pre_", .)) %>%
    #select("id" | where(is.numeric) )
  
  
  
  data_cor <- merge( data_cor, 
                   data_cor_pre[-c(2)], by = c("id", "variable") )
  droplevels(data_cor)
}

bdc <- "BDC-3"
df_tmp <-  func_bdc_cov_desc(df_vbm_wb_sum)

# Adjust for age and sex
# Define id vars
id_var <- c("id", "time.f", "group_3", "sex", "age")
id_var_cast <- id + time.f ~ variable
data_select <- c("id", "time.f", "resid", "variable")


e1 <- resid(lm(y ~ Sex)), ii) 
e2 <- resid(lm(X ~ Sex)), and 
finally iii) lm(e1 ~ e2) 

library(modelr)
func_age_sex_cor_v2 <- function(data,...){
  # Create pre
  data_cor <- melt(df_vbm_wb_sum, id.var = c("id", "time.f"))
  
  dat_pre <- subset(dat, time.f == bdc)
  colnames(dat_pre)[4] <- "pre"
  
  # Add pre to df
  data_cor <- merge( dat, 
                   dat_pre[-c(2:5)], by = c("id", "variable") )
  droplevels(data_cor)
  
  # Add Demo
  data_cor <- merge(data_cor, df_demo[c(1,3,5,6)], by ="id")
  
  data_cor <- data_cor[c(1,3:6,2,8,7)]
  # Adjust for Age and Sex
  data_cor <- data_cor %>%
    group_by(variable) %>% 
    add_residuals (lm(value ~ pre + age + sex, .) )
    #add_residuals (lmer(value ~ pre + age + sex + (1|id), REML = T, .) )
  
  
  
  # Clean
  data_cor <- subset(data_cor, select = c(data_select) )
  data_cor <- dcast(data_cor, id_var_cast, value.var = "resid")
  return(data_cor)
}

  
    do(tidy(lm(value ~ age, .))) %>%
    filter(term == "age") %>%
    mutate(beta_age = estimate) %>%
    as.data.frame()
  data_coef <- data_coef[c(1,7)]
  data_cor <- merge(data_reg, data_coef, by=c("variable"))
  data_cor$mean_age <- mean(data_cor$age, na.rm=T)
  data_cor$value_adj_age <- data_cor$value - (data_cor$beta_age * (data_cor$age - data_cor$mean_age))
  
  # Adjust for Sex
  data_coef <- data_cor %>%
    group_by(variable) %>% 
    do(tidy(lm(value_adj_age ~ sex, .))) %>% 
    filter(term == "sex") %>% 
    mutate(beta_sex = estimate) %>%
    as.data.frame()
  data_coef <- data_coef[c(1,7)]
  data_cor <- merge(data_cor, data_coef, by=c("variable"))
  data_cor$mean_sex <- mean(data_cor$sex, na.rm =T)
  data_cor$value_adj_age_sex <- data_cor$value_adj_age - (data_cor$beta_sex * (data_cor$sex - data_cor$sex))
  
  # Clean
  data_cor <- subset(data_cor, select = c(data_select) )
  #data_cor <- data_cor[c(2,1,3,4,14)]
  data_cor <- dcast(data_cor, id_var_cast, value.var = "resid")
  return(data_cor)
}

# Adjust for age and sex
df_tmp <- func_age_sex_cor_v2(df_vbm_wb_sum)

# Plot arithmetic means
# Compute desc
desc <- func_desc(df_tmp, group_3, time.f, variable)

bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

func_bdc_correction_new <-
function(data,..){
 df_tmp <- data %>%
    subset(time.f == bdc) %>%
    group_by(variable) %>%
    dplyr::summarise(
      mean_bdc_by_group = mean(MEAN, na.rm = T)
      )
  
  df_tmp <- merge(df_tmp, data, by = c("variable") )
  df_tmp <- df_tmp %>%
    mutate(MEAN_corr = case_when(time.f == bdc ~
                              MEAN-mean_bdc_by_group,
                            TRUE ~ MEAN)) %>%
    select( c(!mean_bdc_by_group & !MEAN) ) %>%
    dplyr::rename(MEAN = MEAN_corr)
}

# Plot desc 
# New facet label names for variable
new_labels <- c("GM Increase","GM Decrease")
names(new_labels) <- c("wb_increase_z","wb_decrease_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

tmpaes_geombar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels)

facet_grid_def <- facet_wrap(variable ~.,
                             switch = "y",
                             labeller = labeller_def,
                             ncol = 1, scales = "free") 

p_vbm_wb_sum_desc_desc
p_vbm_wb_sum_desc_sex_age
p_vbm_wb_sum_desc_sex_age_bdc_cor
p_vbm_wb_sum_desc_sex_age_org_bdc_cor
p_vbm_wb_sum_desc_sex_age_bdc_cor_new
p_vbm_wb_sum_desc_sex_age_org_bdc_cor_new


# Draw plot
pd <- position_dodge(0.3)
p_vbm_wb_sum_desc  <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT30", "HDT59"
, "R+11"),                                       group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

p_vbm_wb_sum_desc_desc
p_vbm_wb_sum_desc_sex_age_org
p_vbm_wb_sum_desc_sex_age
p_vbm_wb_sum_desc_sex_age_bdc_cor
p_vbm_wb_sum_desc_sex_age_bdc_cor_new


# Add zero line
p_vbm_wb_sum_desc <- p_vbm_wb_sum_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p_vbm_wb_sum_desc <- p_vbm_wb_sum_desc + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model Time x Group Interaction 
```{r mixed model for time x group vbm whole-brain}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_vbm_wb_sum)

# Convert sex to continuous var
#df_tmp$sex <- as.numeric(df_tmp$sex)
#df_tmp$sex.n <-revalue(df_tmp$sex, c("M"="1", "F"="0")) #library(plyr)
#df_tmp$sex.n <- as.numeric(df_tmp$sex.n)

# Add demo Data
df_tmp <- merge(df_demo[c(1,3,5:6)], df_vbm_wb_sum, by  = c("id")) 

# Select dep vars
dvList <- c("wb_increase_z","wb_decrease_z") 

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Sex",
  "Age",
  "Group",
  "Time",
  "Group x Time"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", 4)
Variable <- c("Increase GMV", blanks,"Decrease GMV", blanks)
tbl_mm_fac_aov_df_vbm_wb <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for VBM Fluid Shifts.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_vbm_wb <- tbl_mm_fac_aov_df_vbm_wb %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_vbm_wb
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time vbm whole-brain}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3
#model_mm <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Increase GMV", rep("", tmp_n_dvs),
                                   "Decrease GMV", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Time <- rep ( c(
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+11", rep("", tmp_n_time)),
                                   length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_df_vbm_wb <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Group Contrasts for Whole-Brain VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_vbm_wb <- tbl_contr_emm_fac_df_vbm_wb %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_vbm_wb
```
##Contrasts for Comparing Time for Each Group During Bed Rest
```{r contrasts for groups by group vbm whole-brain}

# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3
#model_mm <- ~ time.f * group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3")

# Run contrasts
tbl_contr_emm_fac_df <- func_contrasts_emm_fac(dvList)
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac(dvList)


mm_fac <- func_mm_fac_help(dvList)
  emm_fac_contrasts_p <- lapply( mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells", infer=T) )
  emm_fac_contrasts_p_ <- lapply(emm_fac_contrasts_p, data.frame) #create df
  emm_fac_contrasts_p <- ldply(emm_fac_contrasts_p_, data.frame) #create df
  
  
# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_p_values(dvList)

# Create vars to make nice table
tbl_contr_emm_fac_df$Variable <- c("Increase GMV", rep("", 8),
                                   "Decrease GMV", rep("", 8))

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Ttble for contrasts
tbl_contr_emm_fac_df_vbm_wb <- tbl_contr_emm_fac_df[c(8, 2, 3, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Time Contrasts for Whole-Brain VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_vbm_wb <- tbl_contr_emm_fac_df_vbm_wb %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_vbm_wb
```


##Plot mixed model
```{r mixed model ia vbm}
func_plot_mixed <- function(data, dvList){
  df_tmp <- data
  mm_fac <- func_mm_fac_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells"))
  emm_fac_ <- lapply(emm_fac, data.frame) #create df
  emm_fac <- ldply(emm_fac_, data.frame) #create df
  return(emm_fac)
  remove(emm_fac_)
}

df_emmeans <- func_plot_mixed(df_tmp, dvList)

# Plot 

# New facet label names for variable
new_labels <- c("GM Increase","GM Decrease")
names(new_labels) <- c("wb_increase_z","wb_decrease_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_wrap(.id ~.,
                             switch = "y",
                             labeller = labeller_def,
                             ncol = 1, scales = "free") 

# Draw plot
pd <- position_dodge(0.3)
p_vbm_wb_sum  <- func_plot_line_facet(df_emmeans %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT30", "HDT59"
, "R+11"),                                       group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))



# Add zero line
p_vbm_wb_sum <- p_vbm_wb_sum + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p_vbm_wb_sum <- p_vbm_wb_sum + theme(legend.key.size = unit(0.3, "cm"))

#p_vbm_wb_sum_cells <- p_vbm_wb_sum
```


##Contrasts for Main Effect of Bed Rest
```{r mixed model for main effect group main effect vbm}

bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_vbm_wb_sum)
dvList <- c("wb_increase_z","wb_decrease_z") 

model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )
model_mm <- paste0( " + time.f",  " * group_3", " + (1|id)" )


mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells")) #prop

mm<-lmer(wb_decrease_z ~  pre_wb_decrease_z + age + sex + time.f * group_3 + (1|id), REML = T, data = df_tmp) #pre_wb_decrease_z
emmeans_wtih_pre_sex_age  <- emmeans(mm, ~ time.f * group_3, lmer.df = "satterthwaite", weights = "equal")

emmeans_wo_any
emmeans_wo_pre
emmeans_wtih_pre
emmeans_wtih_pre_sex_age

####################
### Main Effect ####
####################
# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)



# Contrasts
# Define model for contrasts
model_emmeans <- ~  time.f*group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c()

func_contrasts_emm_fac_with_bdc_adj_main <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite", weights = "cells"))
  contrasts_mm_fac <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, contrast_type,
                                                                         by = factors,
                                                                         lmer.df = "satterthwaite",
                                                                         adjust = "fdr"))
  contrasts_mm_fac <- lapply(contrasts_mm_fac, summary, infer=T) #add adj confidence intervals (adjusted if adjustment method is selected: https://cran.r-project.org/web/packages/emmeans/vignettes/confidence-intervals.html)
  contrasts_mm_fac_ <- lapply(contrasts_mm_fac, data.frame) #create df
  contrasts_mm_fac_df <- ldply(contrasts_mm_fac_, data.frame) #create df
  rm(contrasts_mm_fac_)
  return(contrasts_mm_fac_df)
}

func_tbl_contr_emm_fac_with_bdc_adj_main <- function(dvList) {
  tmp <- func_contrasts_emm_fac_with_bdc_adj_main(dvList)
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3) #round
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$estimate," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P FDR adj"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"
  return(tmp)
  }
  
###custom contrasts for comparing levels during bed rest between groups (based on total of 24 emmeans)

##IMPORTANT: MUST USE Interaction term for Emmeans! Otherwise contrast matrix not based on all contrasts in a single list
emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, ~ time.f*group_3 ,lmer.df = "satterthwaite"))

#custom contrasts for comparing leels during bed rest (based on total of 24 emmeans)
CTRL  = c(0,1,1,1,1,1,0,0, 0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0)
cAG   = c(0,0,0,0,0,0,0,0, 0,1,1,1,1,1,0,0, 0,0,0,0,0,0,0,0)
iAG   = c(0,0,0,0,0,0,0,0, 0,0,0,0,0,0,0,0, 0,1,1,1,1,1,0,0)

contrasts_mm_hdbr <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, 
                                                                method = list("cAG - CTRL" = cAG/5 - CTRL/5,
                                                                              "iAG - CTRL" = iAG/5 - CTRL/5,
                                                                              "cAG - iAG"  = cAG/5 - iAG/5), 
                                                                adjust="fdr",
                                                                lmer.df = "satterthwaite")) 
#add adj confidence intervals
contrasts_mm_hdbr <- lapply(contrasts_mm_hdbr, summary, infer=T) #add adj confidence intervals
contrasts_mm_hdbr_ <- lapply(contrasts_mm_hdbr, data.frame) #create df
contrasts_mm_hdbr_df <- ldply(contrasts_mm_hdbr_, data.frame) #create df
rm(contrasts_mm_hdbr_)

Variable <- c("BDNF", rep("",2), "IGF-1",rep("",2),"VEGF",rep("",2),"Cortisol Morn",rep("",2),"Cortisol Eve",rep("",2),"Cortisol Ratio",rep("",2))
#Time <- rep(c("BDC-3", "HDT2","HDT14","HDT30","HDT42","HDT56", "R+1", "R+10"), length(dvList)*2 )
Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

table_contrasts_mm_hdbr_df <- cbind(Variable, Contrast,contrasts_mm_hdbr_df[c(3:9)])
names(table_contrasts_mm_hdbr_df)[3] <- "Estimate"
names(table_contrasts_mm_hdbr_df)[8] <- "t"
names(table_contrasts_mm_hdbr_df)[9] <- "P"

table_contrasts_mm_hdbr_df[c(3:8)] <- round(table_contrasts_mm_hdbr_df[c(3:8)], digits = 2) #round
table_contrasts_mm_hdbr_df[c(9)] <- round(table_contrasts_mm_hdbr_df[c(9)], digits = 3) #round
table_contrasts_mm_hdbr_df$CI <- paste0("(",table_contrasts_mm_hdbr_df$lower.CL,"," ,table_contrasts_mm_hdbr_df$upper.CL,")")
table_contrasts_mm_hdbr_df$CI <- gsub( ",", ", ", table_contrasts_mm_hdbr_df$CI ) 
table_contrasts_mm_hdbr_df <- table_contrasts_mm_hdbr_df[c(1:4,10,5,8,9)]
names(table_contrasts_mm_hdbr_df)[5] <- "95% CI"
table_contrasts_mm_between_main_df_bio <- table_contrasts_mm_hdbr_df
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group vbm wb}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_vbm_wb_sum)

# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+11") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- c("wb_increase_z","wb_decrease_z") 

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 
#tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), summary, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("GM Increase", blanks,"GM Decrease", blanks)
tbl_mm_fac_aov_df_vbm_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for Whole-Brain VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_vbm_main <- tbl_mm_fac_aov_df_vbm_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_vbm_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups vbm wb}
# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

tbl_contr_emm_fac_df$Variable <- c("GM Increase", rep("", 2),
                                   "GM Decrease", rep("", 2))

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_vbm_main <- tbl_contr_emm_fac_df[c(7, 2, 6, 3:5)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_vbm_main <- tbl_contr_emm_fac_vbm_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_vbm_main
```
##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups vbm wb}
# New facet label names for variable
new_labels <- c("","")
names(new_labels) <- c("wb_increase_z","wb_decrease_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_wrap(.~ .id,
                             switch = "y",
                             scales = "free",
                             labeller = labeller_def, 
                             ncol =1) 

# Draw Plot 
pd <- position_dodge(0.99)
p.vbm_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(
                                                   .id = fct_relevel(.id, "wb_increase_z","wb_decrease_z"),
                                                   group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"))) 
# Adjust legend size
p.vbm_emmeans_main <- p.vbm_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
##Create Combined plot 
```{r plot combined vbm wb}
# Combine plot 
p.vbm_comb_wb <- plot_grid(p_vbm_wb_sum_desc, p.vbm_emmeans_main + rremove("x.text") + rremove("y.title")  +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size = 10, 
                        ncol = 2, nrow = 1,
                        rel_widths = c(2.2, 0.8))

# Adjust legend size
p.vbm_comb_wb <- p.vbm_comb_wb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.vbm_comb_wb.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.vbm_comb_wb)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 5, fig.height = 4, echo = FALSE, fig.cap = "VBM: (a) Time course of VBM before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
print(p.vbm_comb_wb)
```
# VBM Insula
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline vbm}
# Adjust for age and sex
# Define id vars
id_var <- c("id", "time.f", "group_3", "sex", "age")
id_var_cast <- id + time.f ~ variable
data_select <- c("id", "time.f", "value_adj_age_sex", "variable")

# Adjust for age and sex
df_tmp <- func_age_sex_cor(df_vbm)

# Plot arithmetic means
# Compute desc
desc <- func_desc(df_tmp, group_3, time.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Plot desc 
# New facet label names for variable
new_labels <- c("Insula L","Insula R")
names(new_labels) <- c("insula_left_z","insula_right_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels)

facet_grid_def <- facet_grid(variable ~.,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.vbm_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT30", "HDT59", "R+11"),
                                            variable = fct_relevel(variable, "insula_left_z","insula_right_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.vbm_desc <- p.vbm_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.vbm_desc <- p.vbm_desc + theme(legend.key.size = unit(0.3, "cm"))
```

##Mixed Model Time x Group Interaction 
```{r mixed model for time x group vbm}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_vbm)

# Select dep vars
dvList <- c("insula_left_z","insula_right_z") 

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Time x Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Insula L", blanks,"Insula R", blanks)
tbl_mm_fac_aov_df_vbm <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_vbm <- tbl_mm_fac_aov_df_vbm %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_vbm
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time vbm}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Insula L", rep("", tmp_n_dvs),
                                   "Insula R", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Time <- rep ( c(
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+11", rep("", tmp_n_time)),
                                   length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Ttble for contrasts
tbl_contr_emm_fac_df_vbm <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Group Contrasts for VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_vbm <- tbl_contr_emm_fac_df_vbm %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_vbm
```
##Contrasts for Comparing Time for Each Group During Bed Rest
```{r contrasts for groups by group vbm insula}
# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_p_values(dvList)

# Create vars to make nice table
tbl_contr_emm_fac_df$Variable <- c("Insula L", rep("", 8),
                                   "Insula R", rep("", 8))

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Ttble for contrasts
tbl_contr_emm_fac_df_vbm_insula <- tbl_contr_emm_fac_df[c(8, 2, 3, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Time Contrasts for Whole-Brain VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_vbm_insula <- tbl_contr_emm_fac_df_vbm_insula %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_vbm_insula
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group vbm}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_vbm)

# Select dep vars
dvList <- c("insula_left_z","insula_right_z") 

# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+11") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- c("insula_left_z","insula_right_z") 

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Insula L", blanks,"Insula R", blanks)
tbl_mm_fac_aov_df_vbm_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_vbm_main <- tbl_mm_fac_aov_df_vbm_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_vbm_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups vbm}
# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

tbl_contr_emm_fac_df$Variable <- c("Insula L", rep("", 2),
                                   "Insula R", rep("", 2))

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_vbm_main <- tbl_contr_emm_fac_df[c(7, 2, 6, 3:5)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for VBM.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_vbm_main <- tbl_contr_emm_fac_vbm_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_vbm_main
```
##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups vbm}
# New facet label names for variable
new_labels <- c("","")
names(new_labels) <- c("insula_left_z","insula_right_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(.id ~ .,
                             switch = "y",
                             scales = "free",
                             labeller = labeller_def) 

# Draw Plot 
pd <- position_dodge(0.99)
p.vbm_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(
                                                   .id = fct_relevel(.id, "insula_left_z","insula_right_z"),
                                                   group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"))) 
# Adjust legend size
p.vbm_emmeans_main <- p.vbm_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
##Create Combined plot 
```{r plot combined vbm}
# Combine plot 
p.vbm_comb <- plot_grid(p.vbm_desc, p.vbm_emmeans_main + rremove("x.text") + rremove("y.title")  +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size = 10, #ncol = 2, nrow = 1,
                        rel_widths = c(2.2, 0.8))

# Adjust legend size
p.vbm_comb <- p.vbm_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.vbm_comb.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.vbm_comb)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 5, fig.height = 4, echo = FALSE, fig.cap = "VBM: (a) Time course of VBM before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
print(p.vbm_comb)
```
# High Res LC
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline lc}
# Plot arithmetic means
# Adjust for age and sex
# Define id vars
id_var <- c("id", "time.f", "group_3", "sex", "age")
id_var_cast <- id + time.f ~ variable
data_select <- c("id", "time.f", "value_adj_age_sex", "variable")

# Adjust for age and sex
df_tmp <- func_age_sex_cor(df_lc)

# Compute desc
desc <- func_desc(df_tmp, group_3, time.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)


# Plot desc 
# New facet label names for variable
new_labels <- c("Locus Coeruleus")
names(new_labels) <- c("lc_fse_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels)

facet_grid_def <- facet_grid(variable ~.,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.lc_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT30", "HDT59", "R+11"),
                                            variable = fct_relevel(variable, "lc_fse_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.lc_desc <- p.lc_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.lc_desc <- p.lc_desc + theme(legend.key.size = unit(0.3, "cm"))
```

##Mixed Model Time x Group Interaction 
```{r mixed model for time x group lc}
# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_lc)

# Select dep vars
dvList <- c("lc_fse_z") 

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Time x Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Locus Coeruleus", blanks)
tbl_mm_fac_aov_df_lc <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for LC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_lc <- tbl_mm_fac_aov_df_lc %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_lc
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time lc}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("Locus Coeruleus", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Time <- rep ( c(
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+11", rep("", tmp_n_time)),
                                   length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Ttble for contrasts
tbl_contr_emm_fac_df_lc <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Group Contrasts for LC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_lc <- tbl_contr_emm_fac_df_lc %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_lc
```
##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time lc}
# Define model for emmeans
model_emmeans <- ~ time.f * group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# New facet label names for variable
new_labels <- c("Locus Coeruleus")
names(new_labels) <- c("lc_fse_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(.id ~ .,
                             switch = "y",
                             labeller = labeller_def) 

# Draw plot
pd <- position_dodge(0.3)
p.lc_emmeans <- func_plot_line_facet(emm_fac %>%
                                        mutate(time.f = fct_relevel(time.f, "HDT30", "HDT59", "R+11"),
                                               .id = fct_relevel(.id, "lc_fse_z"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.lc_emmeans <- p.lc_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.lc_emmeans <- p.lc_emmeans + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group lc}
# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+11") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- c("lc_fse_z")

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("Locus Coeruleus", blanks)
tbl_mm_fac_aov_df_lc_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for LC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_lc_main <- tbl_mm_fac_aov_df_lc_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_lc_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups lc}

mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)

# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)


tbl_contr_emm_fac_df$Variable <- c("Locus Coeruleus", rep("", 2))

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Table for contrasts
tbl_contr_emm_fac_lc_main <- tbl_contr_emm_fac_df[c(7, 2, 6, 3:5)]
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for LC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_lc_main <- tbl_contr_emm_fac_lc_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_lc_main
```
##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups lc}
# New facet label names for variable
new_labels <- c("Locus Coeruleus")
names(new_labels) <- c("lc_fse_z") 

# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(.id ~ .,
                             switch = "y",
                             scales = "free",
                             labeller = labeller_def) 

# Draw Plot 
pd <- position_dodge(0.99)
p.lc_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(
                                                   .id = fct_relevel(.id, "insula_left_z","insula_right_z"),
                                                   group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"))) 
# Adjust legend size
p.lc_emmeans_main <- p.lc_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))
```
##Create Combined plot 
```{r plot combined lc}
# Combine plot 
p.lc_comb <- plot_grid(p.lc_desc, p.lc_emmeans_main + rremove("x.text") + rremove("y.title") +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size =10,#ncol = 1, nrow = 1,
                        rel_widths = c(2.2, 0.8))

# Adjust legend size
p.lc_comb <- p.lc_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.lc_comb.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.lc_comb)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 5, fig.height = 2.5, echo = FALSE, fig.cap = "LC: (a) Time course of LC before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.lc_comb
```
# High Res HC
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline hc}
# Plot arithmetic means

# Adjust for age and sex
# Define id vars
id_var <- c("id", "time.f", "group_3", "sex", "age")
id_var_cast <- id + time.f ~ variable
data_select <- c("id", "time.f", "value_adj_age_sex", "variable")

# Adjust for age and sex
df_tmp <- func_age_sex_cor( subset(df_hc, select = -c(hc_total_z, misc_left_z, misc_right_z, misc_z))  )

# Compute desc
desc <- func_desc(df_tmp, group_3, time.f, variable)

# Compute desc
dvList <- colnames(df_hc)[c(3:ncol(df_hc))]

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Plot desc 
# New facet label names for variable

new_labels <- c("BA35 L","BA35 R", "BA35",
                "BA36 L","BA36 R", "BA36",
                "CA1 L","CA1 R", "CA1",
                "CA2 L","CA2 R", "CA2",
                "CA3 L","CA3 R", "CA3",
                "DG L","DG R", "DG",
                "ERC L","ERC R", "ERC",
                "SULCUS L", "SULCUS R", "SULCUS",
                "SUB L", "SUB R", "SUB",
                "PHC L", "PHC R", "PHC")

                #"HC Total")

names(new_labels) <- c("ba35_left_z", "ba35_right_z", "ba35_z", 
                       "ba36_left_z", "ba36_right_z", "ba36_z", 
                       "ca1_left_z", "ca1_right_z", "ca1_z", 
                       "ca2_left_z", "ca2_right_z", "ca2_z",
                       "ca3_left_z", "ca3_right_z", "ca3_z",
                       "dg_left_z", "dg_right_z", "dg_z",
                       "erc_left_z", "erc_right_z", "erc_z",
                       "sulcus_left_z", "sulcus_right_z", "sulcus_z",
                       "sub_left_z",  "sub_right_z", "sub_z",
                       "phc_left_z",  "phc_right_z", "phc_z")
                       
                        #"hc_total_z")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels)

facet_grid_def <- facet_wrap(.~ variable,
                             switch = "y",
                             labeller = labeller_def,
                             ncol = 3)
                             

# Draw plot
pd <- position_dodge(0.3)
p.hc_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT30", "HDT59", "R+11"),
                                            variable = fct_relevel(variable, "ba35_left_z", "ba35_right_z", "ba35_z", 
                       "ba36_left_z", "ba36_right_z", "ba36_z", 
                       "ca1_left_z", "ca1_right_z", "ca1_z", 
                       "ca2_left_z", "ca2_right_z", "ca2_z",
                       "ca3_left_z", "ca3_right_z", "ca3_z",
                       "dg_left_z", "dg_right_z", "dg_z",
                       "erc_left_z", "erc_right_z", "erc_z",
                       "sulcus_left_z", "sulcus_right_z", "sulcus_z",
                       "sub_left_z",  "sub_right_z", "sub_z",
                       "phc_left_z",  "phc_right_z", "phc_z"), #"hc_total_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.hc_desc <- p.hc_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.hc_desc <- p.hc_desc + theme(legend.key.size = unit(0.3, "cm"))


# DG only
facet_grid_def <- facet_wrap(.~ variable,
                             switch = "y",
                             labeller = labeller_def,
                             ncol = 1)

p.hc_desc_dg <- func_plot_line_facet( subset(desc, variable == "dg_left_z" | variable == "dg_right_z") %>%
                                        mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT30", "HDT59", "R+11"),
                                               variable = fct_relevel(variable, "dg_left_z", "dg_right_z"), #"hc_total_z"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")
                                               )
                                      )
# Add zero line
p.hc_desc_dg <- p.hc_desc_dg + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.hc_desc_dg <- p.hc_desc_dg + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model Time x Group Interaction 
```{r mixed model for time x group hc}

##### ANALYSES BY SIDE NOT DONE ####
# create df with side as variable
df_tmp <- df_hc %>% select( contains("left") | contains("right") | "id" | "time.f")

df_tmp <- melt(df_tmp, id.vars = c("id", "time.f") )

df_tmp$side <-str_replace(df_tmp$variable, pattern = ".*_([^-]*)_.*", replacement = "\\1")

df_tmp$variable <- gsub( "_.*$", "", df_tmp$variable )

df_tmp$variable <- paste(df_tmp$variable, "z", sep = "_")

df_tmp <- as_tibble(df_tmp)

df_tmp[c(1:3,5)] <- lapply(df_tmp[c(1:3,5)], as.factor)

df_tmp <- dcast(df_tmp, id + time.f + side ~ variable, value.var = "value" )
#########

# select data
df_tmp <- subset( df_hc, select = -c(hc_total_z, misc_left_z, misc_right_z, misc_z) )
#df_tmp <- subset( df_tmp, time.f != "R+11")     

#df_tmp <- df_hc %>% select( contains("left") | contains("right") | "id" | "time.f")

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp)[c(40:ncol(df_tmp))] 

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f", " * group_3", "+ (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Time x Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("BA35 L", blanks, "BA35 R", blanks, "BA35", blanks, 
                "BA36 L", blanks, "BA36 R", blanks, "BA36", blanks, 
                "CA1 L", blanks, "CA1 R", blanks, "CA1", blanks, 
                "CA2 L", blanks, "CA2 R", blanks, "CA2", blanks, 
                "CA3 L", blanks, "CA3 R", blanks, "CA3", blanks, 
                "DG L", blanks, "DG R", blanks, "DG", blanks, 
                "ERC L", blanks, "ERC R", blanks, "ERC", blanks, 
                "SULCUS L", blanks, "SULCUS R", blanks, "SULCUS", blanks, 
                "SUB L", blanks, "SUB R", blanks, "SUB", blanks, 
                "PHC L", blanks, "PHC R", blanks, "PHC", blanks )
tbl_mm_fac_aov_df_hc <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for HC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_hc <- tbl_mm_fac_aov_df_hc %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_hc
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time hc}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("BA35 L", rep("", tmp_n_dvs), "BA35 R", rep("", tmp_n_dvs), "BA35", rep("", tmp_n_dvs),
                "BA36 L", rep("", tmp_n_dvs), "BA36 R", rep("", tmp_n_dvs), "BA36", rep("", tmp_n_dvs),
                "CA1 L", rep("", tmp_n_dvs), "CA1 R", rep("", tmp_n_dvs), "CA1", rep("", tmp_n_dvs),
                "CA2 L",rep("", tmp_n_dvs), "CA2 R", rep("", tmp_n_dvs), "CA2", rep("", tmp_n_dvs),
                "CA3 L", rep("", tmp_n_dvs), "CA3 R", rep("", tmp_n_dvs), "CA3", rep("", tmp_n_dvs),
                "DG L", rep("", tmp_n_dvs), "DG R", rep("", tmp_n_dvs), "DG", rep("", tmp_n_dvs),
                "ERC L", rep("", tmp_n_dvs), "ERC R", rep("", tmp_n_dvs), "ERC", rep("", tmp_n_dvs),
                "SULCUS L", rep("", tmp_n_dvs), "SULCUS R", rep("", tmp_n_dvs), "SULCUS", rep("", tmp_n_dvs),
                "SUB L", rep("", tmp_n_dvs), "SUB R", rep("", tmp_n_dvs), "SUB", rep("", tmp_n_dvs),
                "PHC L", rep("", tmp_n_dvs), "PHC R", rep("", tmp_n_dvs), "PHC", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Time <- rep ( c(
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT59", rep("", tmp_n_time),
                                     "R+11", rep("", tmp_n_time)),
                                   length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Ttble for contrasts
tbl_contr_emm_fac_df_hc <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Group Contrasts for HC", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_hc <- tbl_contr_emm_fac_df_hc %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_hc
```
##Contrasts for Comparing Time for Each Group During Bed Rest
```{r contrasts for groups by group hc}
df_tmp <- subset( df_hc, select = -c(hc_total_z, misc_left_z, misc_right_z, misc_z) )
#df_tmp <- subset( df_tmp, time.f != "R+11")     

#df_tmp <- df_hc %>% select( contains("left") | contains("right") | "id" | "time.f")

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp)[c(40:ncol(df_tmp))] 

# Add demo
df_tmp <- merge(df_demo, df_hc, by  = c("id")) 

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac(dvList)

# Create vars to make nice table
blanks <- rep("", 8)
tbl_contr_emm_fac_df$Variable <- c("Insula L", blanks,"Insula R", blanks)

# Table for contrasts
tbl_contr_emm_fac_df_vbm <- tbl_contr_emm_fac_df[c(8,2, 3,7, 4:6)]
```
```{r tab.cap = "Mixed Model Time Contrasts for Whole-Brain VBM Insula.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_vbm <- tbl_contr_emm_fac_df_vbm %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_vbm
```

##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time hc}
df_tmp <- subset( df_hc, select = -c(hc_total_z, misc_left_z, misc_right_z, misc_z) )
#df_tmp <- subset( df_tmp, time.f != "R+11")     

#df_tmp <- df_hc %>% select( contains("left") | contains("right") | "id" | "time.f")

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Define model for emmeans
model_emmeans <- ~ time.f * group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# New facet label names for variable
new_labels <- c("BA35 L","BA35 R", "BA35",
                "BA36 L","BA36 R", "BA36",
                "CA1 L","CA1 R", "CA1",
                "CA2 L","CA2 R", "CA2",
                "CA3 L","CA3 R", "CA3",
                "","", "DG",
                "ERC L","ERC R", "ERC",
                "SULCUS L", "SULCUS R", "SULCUS",
                "SUB L", "SUB R", "SUB",
                "PHC L", "PHC R", "PHC")

                #"HC Total")

names(new_labels) <- c("ba35_left_z", "ba35_right_z", "ba35_z", 
                       "ba36_left_z", "ba36_right_z", "ba36_z", 
                       "ca1_left_z", "ca1_right_z", "ca1_z", 
                       "ca2_left_z", "ca2_right_z", "ca2_z",
                       "ca3_left_z", "ca3_right_z", "ca3_z",
                       "dg_left_z", "dg_right_z", "dg_z",
                       "erc_left_z", "erc_right_z", "erc_z",
                       "sulcus_left_z", "sulcus_right_z", "sulcus_z",
                       "sub_left_z",  "sub_right_z", "sub_z",
                       "phc_left_z",  "phc_right_z", "phc_z")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_wrap(. ~ .id,
                             switch = "y",
                             labeller = labeller_def,
                             ncol = 3,
                             scales = "free") 

# Draw plot
pd <- position_dodge(0.3)
p.hc_emmeans <- func_plot_line_facet(emm_fac %>%
                                     mutate(time.f = fct_relevel(time.f, "HDT30", "HDT59", "R+11"),
                                            .id = fct_relevel(.id, "ba35_left_z", "ba35_right_z", "ba35_z", 
                       "ba36_left_z", "ba36_right_z", "ba36_z", 
                       "ca1_left_z", "ca1_right_z", "ca1_z", 
                       "ca2_left_z", "ca2_right_z", "ca2_z",
                       "ca3_left_z", "ca3_right_z", "ca3_z",
                       "dg_left_z", "dg_right_z", "dg_z",
                       "erc_left_z", "erc_right_z", "erc_z",
                       "sulcus_left_z", "sulcus_right_z", "sulcus_z",
                       "sub_left_z",  "sub_right_z", "sub_z",
                       "phc_left_z",  "phc_right_z", "phc_z"), #"hc_total_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.hc_emmeans <- p.hc_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.hc_emmeans <- p.hc_emmeans + theme(legend.key.size = unit(0.3, "cm"))

# DG only
p.hc_emmeans_dg <- func_plot_line_facet( subset(emm_fac, .id == "dg_left_z" | .id == "dg_right_z") %>%
                                        mutate(time.f = fct_relevel(time.f, "HDT30", "HDT59", "R+11"),
                                               .id = fct_relevel(.id, "dg_left_z", "dg_right_z"), #"hc_total_z"),
                                               group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")
                                               )
                                      )
# Add zero line
p.hc_emmeans_dg <- p.hc_emmeans_dg + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.hc_emmeans_dg <- p.hc_emmeans_dg + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group hc}
# Drop recovery
df_tmp <- subset(df_tmp, time.f !="R+11") # Drop baseline
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp)[c(40:ncol(df_tmp))]

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("BA35 L", blanks, "BA35 R", blanks, "BA35", blanks, 
                "BA36 L", blanks, "BA36 R", blanks, "BA36", blanks, 
                "CA1 L", blanks, "CA1 R", blanks, "CA1", blanks, 
                "CA2 L", blanks, "CA2 R", blanks, "CA2", blanks, 
                "CA3 L", blanks, "CA3 R", blanks, "CA3", blanks, 
                "DG L", blanks, "DG R", blanks, "DG", blanks, 
                "ERC L", blanks, "ERC R", blanks, "ERC", blanks, 
                "SULCUS L", blanks, "SULCUS R", blanks, "SULCUS", blanks, 
                "SUB L", blanks, "SUB R", blanks, "SUB", blanks, 
                "PHC L", blanks, "PHC R", blanks, "PHC", blanks )
tbl_mm_fac_aov_df_hc_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for HC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_hc_main <- tbl_mm_fac_aov_df_hc_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_hc_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups hc}
# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$.id)) -1
tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("BA35 L", rep("", 2), "BA35 R", rep("", 2), "BA35", rep("", 2),
                "BA36 L", rep("", 2), "BA36 R", rep("", 2), "BA36", rep("", 2),
                "CA1 L", rep("", 2), "CA1 R", rep("", 2), "CA1", rep("", 2),
                "CA2 L",rep("", 2), "CA2 R", rep("", 2), "CA2", rep("", 2),
                "CA3 L", rep("", 2), "CA3 R", rep("", 2), "CA3", rep("", 2),
                "DG L", rep("", 2), "DG R", rep("", 2), "DG", rep("", 2),
                "ERC L", rep("", 2), "ERC R", rep("", 2), "ERC", rep("", 2),
                "SULCUS L", rep("", 2), "SULCUS R", rep("", 2), "SULCUS", rep("", 2),
                "SUB L", rep("", 2), "SUB R", rep("", 2), "SUB", rep("", 2),
                "PHC L", rep("", 2), "PHC R", rep("", 2), "PHC", rep("", 2))

# Table for contrasts
tbl_contr_emm_fac_hc_main <- tbl_contr_emm_fac_df[c(7, 2, 6, 3:5)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for HC.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_hc_main <- tbl_contr_emm_fac_hc_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_hc_main
```

##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups HC}
# New facet label names for variable
new_labels <- c("BA35 L","BA35 R", "BA35",
                "BA36 L","BA36 R", "BA36",
                "CA1 L","CA1 R", "CA1",
                "CA2 L","CA2 R", "CA2",
                "CA3 L","CA3 R", "CA3",
                "","", "DG",
                "ERC L","ERC R", "ERC",
                "SULCUS L", "SULCUS R", "SULCUS",
                "SUB L", "SUB R", "SUB",
                "PHC L", "PHC R", "PHC")

                #"HC Total")

names(new_labels) <- c("ba35_left_z", "ba35_right_z", "ba35_z", 
                       "ba36_left_z", "ba36_right_z", "ba36_z", 
                       "ca1_left_z", "ca1_right_z", "ca1_z", 
                       "ca2_left_z", "ca2_right_z", "ca2_z",
                       "ca3_left_z", "ca3_right_z", "ca3_z",
                       "dg_left_z", "dg_right_z", "dg_z",
                       "erc_left_z", "erc_right_z", "erc_z",
                       "sulcus_left_z", "sulcus_right_z", "sulcus_z",
                       "sub_left_z",  "sub_right_z", "sub_z",
                       "phc_left_z",  "phc_right_z", "phc_z")

# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_wrap(. ~ .id,
                             switch = "y",
                             scales = "free",
                             labeller = labeller_def,
                             ncol = 3) 

# Draw Plot 
pd <- position_dodge(0.99)
p.hc_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                            mutate(
                                                   .id = fct_relevel(.id, "ba35_left_z", "ba35_right_z", "ba35_z", 
                       "ba36_left_z", "ba36_right_z", "ba36_z", 
                       "ca1_left_z", "ca1_right_z", "ca1_z", 
                       "ca2_left_z", "ca2_right_z", "ca2_z",
                       "ca3_left_z", "ca3_right_z", "ca3_z",
                       "dg_left_z", "dg_right_z", "dg_z",
                       "erc_left_z", "erc_right_z", "erc_z",
                       "sulcus_left_z", "sulcus_right_z", "sulcus_z",
                       "sub_left_z",  "sub_right_z", "sub_z",
                       "phc_left_z",  "phc_right_z", "phc_z"), #"hc_total_z"),
                                                   group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"))) 
# Adjust legend size
p.hc_emmeans_main <- p.hc_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))

# DG only
facet_grid_def <- facet_wrap(.id ~ .,
                             #switch = "y",
                             scales = "free",
                             labeller = labeller_def,
                             ncol = 1) 

p.hc_emmeans_main_dg <- func_plot_bar_facet( subset(emm_fac, .id == "dg_left_z" | .id == "dg_right_z") %>%
                                            mutate(.id = fct_relevel(.id, "dg_left_z", "dg_right_z"), #"hc_total_z"),
                                                   group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"))) 
# Adjust legend size
p.hc_emmeans_main_dg <- p.hc_emmeans_main_dg + theme(legend.key.size = unit(0.3, "cm"))
```
##Create Combined plot 
```{r plot combined hc}
# Combine plot 
p.hc_comb <- plot_grid(p.hc_desc, p.hc_emmeans_main + rremove("x.text") + rremove("y.title") +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"),
                        ncol = 2, nrow = 1, label_size = 10,
                        rel_widths = c(1.5, 1.5))

# Adjust legend size
p.hc_comb <- p.hc_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.hc_comb.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.hc_comb)
dev.off()

# Combine plot 
p.hc_comb_dg <- plot_grid(p.hc_desc_dg, p.hc_emmeans_main_dg + rremove("x.text") +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size =10,
                        rel_widths = c(2.2, 0.8))

# Adjust legend size
p.hc_comb_dg <- p.hc_comb_dg + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.hc_comb_dg.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.hc_comb_dg)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 7, fig.height = 8, echo = FALSE, fig.cap = "HC: (a) Time course of HC before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.hc_comb
```

```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 5, fig.height = 4, echo = FALSE, fig.cap = "HC: (a) Time course of DG before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.hc_comb_dg
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 2.5, fig.height = 2, echo = FALSE, fig.cap = "Effect of bed rest on DG volume. Data are means and SD adjusted for baseline, age, and sex."}
p.hc_emmeans_main_dg
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 4.5, fig.height = 4, echo = FALSE, fig.cap = "HC: (a) Time course of DG before, during, and after bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.hc_comb_dg
```
# MTR HC
```{r MTR HC}
# Select data
df_mtr_tmp <- df_mtr[c(1:2,5:6)]

df_hc_tmp <- subset( df_hc, select = c(id, time.f, hc_total_z, dg_left_z, dg_right_z, dg_z) )

df_tmp <- merge(df_mtr_tmp, df_hc_tmp, by = c("id", "time.f"))

df_tmp <- melt(df_tmp, id.vars = c("id", "time.f"))
df_tmp <- as_tibble(df_tmp)

# Compute Change scores
df_tmp_change <- df_tmp %>%
  group_by(id, variable) %>%
  dplyr::summarise(
    change_hdt30 = value[time.f == "HDT30"] - value[time.f == "BDC-3"],
    change_hdt59 = value[time.f == "HDT59"] - value[time.f == "BDC-3"],
    change_r11 = value[time.f == "R+11"] - value[time.f == "BDC-3"],
  )

df_tmp_change <- df_tmp_change %>% 
  filter(!str_detect(variable, 'dg_z') & !str_detect(variable, 'hc_total_z'))
df_tmp_change <- droplevels(df_tmp_change)

# Add side as var
df_tmp_change$side <- str_replace(df_tmp_change$variable, pattern = ".*_([^-]*)_.*", replacement = "\\1")

# Clean var
df_tmp_change$variable <- gsub( "_right", "", df_tmp_change$variable )
df_tmp_change$variable <- gsub( "_left", "", df_tmp_change$variable )

# Convert data types
df_tmp_change[c(1:2,6)] <- lapply(df_tmp_change[c(1:2,6)], as.factor)

# Convert to long
df_tmp_change <- melt(df_tmp_change, id.vars = c("id", "variable", "side"))
colnames(df_tmp_change)[4] <- "time"

df_tmp_change <- dcast(df_tmp_change, id + side ~ variable + time, value.var = c("value"))

# Plot scatter
p.scatter_hc_mtr <- ggplot(df_tmp_change, aes(x = mtr_hc_z_change_hdt59, y = dg_z_change_hdt59 )) +
    geom_point(aes(color = factor(side))) +
    stat_smooth(method = "lm",
        col = "black",
        se = FALSE,
        size = 1)
# Regression
reg_hc_mtr <- summary ( lm(mtr_hc_z_change_hdt59 ~ dg_z_change_hdt59, data = df_tmp_change) )

# Repeated Measures Correlation
library(rmcorr)


```
# TASK fmri Pattern Separation
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline task fmri patsep}
# Plot arithmetic means
# define dep vars
dvList <- colnames(df_patsep)[c(4:ncol(df_patsep))]

# Adjust for age and sex
# Define id vars
id_var <- c("id", "time.f", "cond.f", "group_3", "sex", "age")
id_var_cast <- id + time.f + cond.f ~ variable
data_select <- c("id", "time.f", "value_adj_age_sex", "variable", "cond.f")

df_tmp <- func_age_sex_cor(df_patsep)

# Compute desc
desc <- func_desc(df_tmp, group_3, time.f, cond.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Plot desc 
# New facet label names for variable
new_labels <- c("HC L","HC R",
                "PHG L","PHG R",
                "Precuneus L","Precuneus R")

names(new_labels) <- c("hc_left_z", "hc_right_z",
                       "phc_left_z", "phc_right_z",
                       "precu_left_z", "precu_right_z")
                       
new_labels2 <- c("Lure", "Repetition")
names(new_labels2) <- c("Lure", "Repetition")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

tmpaes_geombar <- aes(x = time.f,
                    y = MEAN, 
                    fill=group_3,
                    color = group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels,
                         cond.f = new_labels2)

facet_grid_def <- facet_wrap(variable ~ cond.f,
                             ncol = 2,
                             labeller = labeller_def)

# Draw plot
pd <- position_dodge(0.3)
p.patsep_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT59"),
                                            variable = fct_relevel(variable, "hc_left_z", "hc_right_z", "phc_left_z", "phc_right_z", "precu_left_z", "precu_right_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.patsep_desc <- p.patsep_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.patsep_desc <- p.patsep_desc + theme(legend.key.size = unit(0.3, "cm"))

# Drop Precuneus
p.patsep_desc_hc_phg <- func_plot_line_facet( subset(desc, variable != "precu_left_z" & variable != "precu_right_z") %>%
                                     mutate(
                                       cond.f = fct_relevel(cond.f, "Repetition", "Lure"),
                                       variable = fct_relevel(variable, "hc_left_z", "hc_right_z", "phc_left_z", "phc_right_z"),
                                       group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")
                                       )
                                     )

# Add zero line
p.patsep_desc_hc_phg <- p.patsep_desc_hc_phg + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.patsep_desc_hc_phg <- p.patsep_desc_hc_phg + theme(legend.key.size = unit(0.3, "cm"))
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 8, fig.height = 5, echo = FALSE, fig.cap = "Pattern Separation Task. Data are means and SD."}
p.patsep_desc
```
##Mixed Model Time x Group Interaction 
```{r mixed model for time x group task fmri patsep}
# select data
df_tmp <- df_patsep

# Add baseline as cov
bdc <- "BDC-3"
df_tmp <-  func_bdc_cov(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp)[c(17:ncol(df_tmp))] 

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " * cond.f", "+ (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group",
  "Condition",
  "Group x Condition"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("HC L", blanks, "HC R", blanks,
                "PHG L", blanks, "PHG R", blanks,
                "Precuneus L", blanks, "Precuneus R", blanks)
tbl_mm_fac_aov_df_patsep <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for Pattern Separation.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_patsep <- tbl_mm_fac_aov_df_patsep %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_patsep
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by group and condition rsfrmi patsep}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ cond.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("cond.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$cond.f)) -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1


tbl_contr_emm_fac_df$Variable <- c("HC L", rep("", tmp_n_dvs), "HC R", rep("", tmp_n_dvs), 
                "PHG L", rep("", tmp_n_dvs), "PHG R", rep("", tmp_n_dvs), 
                "Precuneus L", rep("", tmp_n_dvs), "Precuneus R", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Condtition <- rep ( c(
                                     "Lure", rep("", tmp_n_cond),
                                     "Repetition", rep("", tmp_n_cond)),
                                   length(dvList) )

#table_contrasts_emm_fac_by_time_df$Contrast <- rep(c("cAG vs. CTRL","iAG vs. CTRL", "cAG vs. iAG"), length(dvList))

# Ttble for contrasts
tbl_contr_emm_fac_df_patsep <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Group Contrasts for task fMRI Pattern Separation.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_patsep <- tbl_contr_emm_fac_df_patsep %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P FDR adj"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_patsep
```
##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time rsfmri patsep}
# Define model for emmeans
model_emmeans <- ~ cond.f * group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# New facet label names for variable
new_labels <- c("HC L","HC R",
                "PHG L","PHG R",
                "Precuneus L","Precuneus R")

names(new_labels) <- c("hc_left_z", "hc_right_z",
                       "phc_left_z", "phc_right_z",
                       "precu_left_z", "precu_right_z")
                       
new_labels2 <- c("Lure", "Repetition")
names(new_labels2) <- c("Lure", "Repetition")


# Define aes for func_plot
tmpaes_plot <- aes(x = group_3,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels,
                         cond.f = new_labels2)

facet_grid_def <- facet_wrap(.id ~cond.f ,
                             labeller = labeller_def,
                             ncol = 4)

# Function for plot
func_plot_bar_2 <- function(x) {ggplot(x, tmpaes_plot) + theme_report() +
    geom_hline(yintercept = 0,
               size = 0.3,
               linetype = "solid") +
    geom_errorbar(tmpaes_errorbar,
                 width = .4,
                  position = pd,
                  color = "black") +
    geom_bar(tmpaes_geombar, # separate by category
             stat = "identity", 
             position = pd,
             width = 1.0,
             color = "black") + # make it side-by-side
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "", size = 10) +
    #guides(x = "none") +
    theme(legend.title = element_blank(),
          legend.text = element_text(size=8),
          axis.title.x = element_text(size = 10),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
}

func_plot_bar_facet_2 <- function(x) {func_plot_bar_2(x) +
    facet_grid_def +
    theme(strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5,
                                          linetype = "solid"),
          strip.text = element_text(size = 10,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(2, "lines"))
}


# Draw plot
pd <- position_dodge(0.99)
p.patsep_emmeans <- func_plot_bar_facet(emm_fac %>%
                                     mutate(
                                       cond.f = fct_relevel(cond.f, "Repetition", "Lure"),
                                       .id = fct_relevel(.id, "hc_left_z", "hc_right_z", "phc_left_z", "phc_right_z", "precu_left_z", "precu_right_z"),
                                       group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")
                                       )
                                     )

# Add zero line
#p.patsep_emmeans <- p.patsep_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.patsep_emmeans <- p.patsep_emmeans + theme(legend.key.size = unit(0.3, "cm"))

# Drop Precuneus
p.patsep_emmeans_hc_phg <- func_plot_bar_facet( subset(emm_fac, .id != "precu_left_z" & .id != "precu_right_z") %>%
                                     mutate(
                                       cond.f = fct_relevel(cond.f, "Repetition", "Lure"),
                                       .id = fct_relevel(.id, "hc_left_z", "hc_right_z", "phc_left_z", "phc_right_z"),
                                       group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")
                                       )
                                     )

# Add zero line
#p.patsep_emmeans <- p.patsep_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.patsep_emmeans_hc_phg <- p.patsep_emmeans_hc_phg + theme(legend.key.size = unit(0.3, "cm"))


facet_grid_def <- facet_wrap(.id ~cond.f ,
                             labeller = labeller_def,
                             ncol = 4)

p.patsep_emmeans_hc_phg <- func_plot_bar_facet( subset(emm_fac, .id != "precu_left_z" & .id != "precu_right_z") %>%
                                     mutate(
                                       cond.f = fct_relevel(cond.f, "Repetition", "Lure"),
                                       .id = fct_relevel(.id, "hc_left_z", "hc_right_z", "phc_left_z", "phc_right_z"),
                                       group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")
                                       )
                                     )
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 5, fig.height = 7.5, echo = FALSE, fig.cap = "Pattern Separation: Effect of bed rest on brain activation during pattern separation on HDT59. Data are means and SD adjusted for baseline, age, and sex."}
p.patsep_emmeans
```
##Create Combined plot 
```{r plot combined rsfmri patsep}
# Combine plot 
p.patsep_comb <- plot_grid(p.patsep_desc, p.patsep_emmeans + rremove("x.text") +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size =10,
                        ncol = 2, nrow = 1,
                        rel_widths = c(1.5, 1.5))

# Adjust legend size
p.patsep_comb <- p.patsep_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.patsep_comb.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.patsep_comb)
dev.off()

p.patsep_comb_hc_phg <- plot_grid(p.patsep_desc_hc_phg, p.patsep_emmeans_hc_phg + rremove("x.text") +
                          theme(legend.key.size = unit(0.3, "cm")),
                        labels = c("a", "b"), label_size = 10,
                        ncol = 2, nrow = 1,
                        rel_widths = c(1.5, 1.5))

# Adjust legend size
p.patsep_comb_hc_phg <- p.patsep_comb_hc_phg + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/MRI/p.patsep_comb_hc_phg.pdf",
    width = 20/2.54, 
    height = 10/2.54,
    useDingbats = FALSE) #in cm
print(p.patsep_comb_hc_phg)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 6.5, fig.height = 10, echo = FALSE, fig.cap = "Pattern Separation: (a) Time course of brain activation in response to pattern separation before, during, and after bed rest. (b) Main effect of bed rest on brain activation during pattern separation on HDT59. Data are means and SD adjusted for baseline."}
p.patsep_comb
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 6.5, fig.height = 8, echo = FALSE, fig.cap = "Pattern Separation: (a) Time course of brain activation in response to pattern separation before, during, and after bed rest. (b) Main effect of bed rest on brain activation during pattern separation on HDT59. Data are means and SD adjusted for baseline."}
p.patsep_comb_hc_phg
```
# RESTING STATE fmri
##Merge rsfmri data
```{r merge rsfmri}
# Select data
df_rsfrmi_AGvCTRL_BDC_HDT59_tmp <- df_rsfrmi_AGvCTRL_BDC_HDT59[c(1,2,5)]
df_rsfrmi_AGvCTRL_BDC_HDT59_tmp$variable <- rep( "AGvCTRL_BDC_HDT59_z", nrow(df_rsfrmi_AGvCTRL_BDC_HDT59_tmp) )
colnames(df_rsfrmi_AGvCTRL_BDC_HDT59_tmp)[3] <- "value"


df_rsfrmi_cAGvsCTRL_BDC_HDT59_tmp <- df_rsfrmi_cAGvsCTRL_BDC_HDT59[c(1,2,5)]
df_rsfrmi_cAGvsCTRL_BDC_HDT59_tmp$variable <- rep( "cAGvCTRL_BDC_HDT59_z", nrow(df_rsfrmi_cAGvsCTRL_BDC_HDT59_tmp) )
colnames(df_rsfrmi_cAGvsCTRL_BDC_HDT59_tmp)[3] <- "value"

df_rsfrmi_l_iAG_hc_bdc_hdt59_tmp <- df_rsfrmi_l_iAG_hc_bdc_hdt59[c(1,2,3)]
df_rsfrmi_l_iAG_hc_bdc_hdt59_tmp$variable <- rep( "iAG_l_hc_BDC_HDT59_z", nrow(df_rsfrmi_l_iAG_hc_bdc_hdt59_tmp) )
colnames(df_rsfrmi_l_iAG_hc_bdc_hdt59_tmp)[3] <- "value"

df_rsfrmi <- rbind(df_rsfrmi_AGvCTRL_BDC_HDT59_tmp, df_rsfrmi_cAGvsCTRL_BDC_HDT59_tmp, df_rsfrmi_l_iAG_hc_bdc_hdt59_tmp)

df_rsfrmi <- dcast(df_rsfrmi, id + time.f ~ variable, value.var = "value")
```
##Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline rsfmri}
# Plot arithmetic means
# Adjust for age and sex
# Define id vars
id_var <- c("id", "time.f", "group_3", "sex", "age")
id_var_cast <- id + time.f ~ variable
data_select <- c("id", "time.f", "value_adj_age_sex", "variable")

# Adjust for age and sex
df_tmp <- func_age_sex_cor(df_rsfrmi)

# Compute desc
desc <- func_desc(df_tmp, group_3, time.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
bdc <- c("BDC-3")
desc <- func_bdc_correction(desc)

# Plot desc 
# New facet label names for variable

new_labels <- c("NBS - AG vs CTRL","NBS - cAG vs CTRL", "Seed Analysis HC left- iAG vs CTRL")
names(new_labels) <- c("AGvCTRL_BDC_HDT59_z", "cAGvCTRL_BDC_HDT59_z", "iAG_l_hc_BDC_HDT59_z")
                      

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels)

facet_grid_def <- facet_wrap(.~ variable,
                             switch = "y",
                             labeller = labeller_def,
                             ncol = 3)
                             

# Draw plot
pd <- position_dodge(0.3)
p.rsfmri_desc <- func_plot_line_facet(desc %>%
                                     mutate(time.f = fct_relevel(time.f, "BDC-3", "HDT59"),
                                            variable = fct_relevel(variable, "AGvCTRL_BDC_HDT59_z", "cAGvCTRL_BDC_HDT59_z", "iAG_l_hc_BDC_HDT59_z"),
                                            group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")))

# Add zero line
p.rsfmri_desc <- p.rsfmri_desc + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.rsfmri_desc <- p.rsfmri_desc + theme(legend.key.size = unit(0.3, "cm"))
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 6.5, fig.height = 10, echo = FALSE, fig.cap = "Pattern Separation: (a) Time course of brain activation in response to pattern separation before, during, and after bed rest. (b) Main effect of bed rest on brain activation during pattern separation on HDT59. Data are means and SD adjusted for baseline."}
p.rsfmri_desc
```