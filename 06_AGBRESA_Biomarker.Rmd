---
title: "Appendix Final Report HyperCampus Biomarker"
#author: "A Stahn"
#date: "10/27/2021"
#output:
 # officedown::rdocx_document
  #word_document:
    #number_sections: TRUE
    #fig_caption: TRUE
  #bookdown::html_document2:
  #number_sections: TRUE
  #fig_caption: TRUE
  #always_allow_html: true
output:  
  officedown::rdocx_document:
    tables:
      table.align: "center"
      caption:
        style: Table Caption
        pre: 'Table '
        sep: '. '
        text.align: "left"
    plots:
      align: center
      caption:
        sep: '. '
---
```{r include = FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE, dpi = 300, echo = FALSE)
```
##Required Packages
```{r load required packages, message = FALSE}
library(knitr) # for kable
library(readxl) # read xls
library(DT) # Print table nicely in markdown
library(reshape2) # wide to long
library(plyr) # ldply
library(tidyverse) # for fct_relevel

library(lme4) # for adding mixed model functions to plot
library(lmerTest) # for adding mixed model functions to plot
library(nlme)
library(emmeans) # for adding mixed model marignal means and se to plot
library(qdapTools) # list_df2df(tbl_mm_fac_aov)

library(ggpubr) # for compare means, descriptives and theme_pubr
library(ggplot2)
library(ggsci)
library(scales)
library(cowplot) # for plot_grid, combine plots using cowplot
library(officedown)
library(officer)
library(flextable)
```
## Print Session Info
```{r print R and package versions}
print(sessionInfo())
```
##Themes for Plots
```{r create themes and correction factors}
# Correct ggplot2 pts and fonts
ggplot_factor_line <- ggplot2::.pt*72.27/96
ggplot_factor_font = 1.0

# Create project report theme
theme_report_white  <-  theme_pubr() + theme(
  axis.line = element_line(size = 0.5 / ggplot_factor_line,color="black"),
  axis.ticks = element_line(size = 0.5 / ggplot_factor_line, color="black"),
  axis.ticks.length = unit(0.2, "cm"), 
  text = element_text(size = 8 * ggplot_factor_font,
                      family="Helvetica",
                      colour="black"),
  axis.text.x=element_text(angle = 0, 
                           vjust = 0.5,
                           size = 8 * ggplot_factor_font,
                           family = "Helvetica",
                           colour = "black"), #face="bold"
  axis.text.y = element_text(angle = 0,
                            vjust = 0.5,
                            size= 8 * ggplot_factor_font,
                            family = "Helvetica",
                            colour="black"),
  axis.title.x = element_text(angle = 0,
                            vjust = 0.5,
                            size= 8 * ggplot_factor_font,
                            family="Helvetica",
                            colour="black",
                            face="bold"),
  axis.title.y = element_text(angle = 90,
                            vjust = 0.5,
                            size= 8 * ggplot_factor_font,
                            family = "Helvetica",
                            colour = "black",
                            face = "bold") # face = "bold" 
  )

# Create project report theme
theme_report_white_2  <-  theme_pubr() + theme(
  axis.line = element_line(size = 0.5 / ggplot_factor_line,color= "black"),
  axis.ticks = element_line(size = 0.5 / ggplot_factor_line, color= "black"),
  axis.ticks.length = unit(0.2, "cm"), 
  text = element_text(size = 14 * ggplot_factor_font,
                      family="Helvetica",
                      colour="black"),
  axis.text.x=element_text(angle = 0, 
                           vjust = 0.5,
                           size = 14 * ggplot_factor_font,
                           family = "Helvetica",
                           colour = "black"), #face="bold"
  axis.text.y = element_text(angle = 0,
                            vjust = 0.5,
                            size= 14 * ggplot_factor_font,
                            family = "Helvetica",
                            colour="black"),
  axis.title.x = element_text(angle = 0,
                            vjust = 0.5,
                            size= 16 * ggplot_factor_font,
                            family="Helvetica",
                            colour="black",
                            face="bold"),
  axis.title.y = element_text(angle = 90,
                            vjust = 0.5,
                            size= 16 * ggplot_factor_font,
                            family = "Helvetica",
                            colour = "black",
                            face = "bold") # face = "bold" 
  )

```
# Definition of Helper Functions 
## Descriptive Functions
```{r functions for descriptive stats}
# Function to check data completion 
func_data_completion <- function(data, ...) {
  
  if(!"time.f" %in% names(data)) {
    data$time.f <- as.factor( c( rep(1, nrow(data) ) ) )
    }
  
  if(!"cond.f" %in% names(data)) {
    data$cond.f <- as.factor( c( rep(1, nrow(data) ) ) )
    }
  
  data <- reshape2::melt( data, 
                              id.vars = names( Filter(is.factor, data) )
                              )  %>%
  
  group_by(variable) %>%
  dplyr::summarise(
      N = N_tot * length( levels(time.f) ) * length( levels(cond.f) ),
      n = sum( !is.na(value) ),
      Percent = n / N * 100
      )
}

# Function to compute descriptives
func_desc <- function(data, ...) {
  df_tmp <- df_demo[ , !names(df_demo) %in% c("age","height", "weight")]
  data <- merge(df_tmp, data, by = "id") #add demo
  data <- reshape2::melt( data, 
                              id.vars = names( Filter(is.factor, data) )
                              )
  groups <- enquos(...)
  
  result <- data %>%
    
    group_by(!!!groups) %>%
    
    dplyr::summarise(
      MEAN = mean(value, na.rm = T),
      SE = sd(value, na.rm = T) / sqrt(length(value) )
      )
  return(result)
}

func_bdc_correction <- function(data,..){
 df_tmp <- data %>%
    subset(time.f == "BDC-6" | time.f == "BDC-3") %>%
    group_by(group_3, variable) %>%
    dplyr::summarise(
      mean_bdc_by_group = mean(MEAN, na.rm = T)
      )
  
  df_tmp <- merge(df_tmp, data, by = c("group_3", "variable") )
  df_tmp <- df_tmp %>%
    mutate(MEAN_corr = case_when(time.f == "BDC-6" | time.f == "BDC-3" ~
                              MEAN-mean_bdc_by_group,
                            TRUE ~ MEAN)) %>%
    select( c(!mean_bdc_by_group & !MEAN) ) %>%
    dplyr::rename(MEAN = MEAN_corr)
}
```
##Plot Functions
```{r functions for plots}
# Wrapper function for line plots, forwards to func_plot_line_facet
func_plot_line <- function(x) {ggplot(x, tmpaes_plot) + 
    theme_report() +
    geom_line(position = pd) +
    geom_errorbar(tmpaes_errorbar,
                  width =.4, 
                  position = pd) +
    geom_point(position = pd,
               shape = 21,
               size = 2) + #shape = 21, size = 1, fill = "white"
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "Time", size = 10) +
    theme(legend.title = element_blank(),
          legend.text = element_text(size = 8),
          axis.title.x = element_text(size = 10))
  }

# Function for line plots, takes 'desc' as input
func_plot_line_facet <- function(x) {func_plot_line(x) +
    facet_grid_def +
    theme(strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5,
                                          linetype = "solid"),
          strip.text = element_text(size = 10,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(2, "lines"))
}

# Function for bar plots, forwards to func_plot_bar_facet
func_plot_bar <- function(x) {ggplot(x, tmpaes_plot) + theme_report() +
    geom_hline(yintercept = 0,
               size = 0.3,
               linetype = "solid") +
    geom_errorbar(tmpaes_errorbar,
                 width = .4,
                  position = pd,
                  color = "black") +
    geom_bar(tmpaes_geombar, # separate by category
             stat = "identity", 
             position = pd,
             width = 1.0,
             color = "black") + # make it side-by-side
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "", size = 10) +
    guides(x = "none") +
    theme(legend.title = element_blank(),
          legend.text = element_text(size=8),
          axis.title.x = element_text(size = 10),
          axis.text.x = element_blank(),
          axis.ticks.x = element_blank())
}

# Function for bar plots, takes 'desc*' as input
func_plot_bar_facet <- function(x) {func_plot_bar(x) +
    facet_grid_def +
    theme(strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5,
                                          linetype = "solid"),
          strip.text = element_text(size = 10,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(2, "lines"))
}
```
##Functions for Mixed Models
```{r functions for mixed models}
# Wrapper for appending bdc data as covariate
func_bdc_cov <- function(data, ...) {
  
  df_tmp <- subset(data, time.f != bdc)
  
  df_tmp_pre <- subset(data, time.f == bdc) %>%
    rename_at(vars(contains("_z")), ~ str_c("pre_", .)) %>%
    select("id" | is.numeric)
  
  df_tmp <- merge(df_tmp_pre, df_tmp, by = "id")
  droplevels(df_tmp)
  
  df_tmp <- merge(df_demo, df_tmp,by  = c("id")) 
}

func_bdc_cov_multi_sep_ORG <- function(data, ...) {
  df_tmp <- subset(data[-c(2)], time.n > bdc )
  df_tmp_pre <- subset(data, time.n < (bdc+1) )
  df_tmp_pre <- df_tmp_pre[,!grepl("time.n", colnames(df_tmp_pre))] 
  df_tmp_pre <- 
    reshape2::melt( df_tmp_pre, 
                              id.vars = names( Filter(is.factor, df_tmp_pre) )
                              ) %>%
    group_by(id, variable) %>%
    dplyr::summarise(
      mean_bdc = mean(value, na.rm = T) 
    )
  df_tmp_pre <- reshape2::dcast( df_tmp_pre, id ~ variable, value.var = "mean_bdc") %>%
    rename_at(vars(contains("_z")), ~ str_c("pre_", .))
  df_tmp <- merge(df_tmp_pre, df_tmp, by = c("id") )
  droplevels(df_tmp)
  df_tmp <- merge(df_demo[c(1,3,5:6)], df_tmp, by  = c("id"))
}

func_bdc_cov_multi_sep <- function(data, ...) {
  df_tmp <- subset(data, time.n > bdc )
  df_tmp_pre <- subset(data, time.n < (bdc+1) )
  df_tmp_pre <- df_tmp_pre[,!grepl("time.n", colnames(df_tmp_pre))] 
  df_tmp_pre <- 
    reshape2::melt( df_tmp_pre, 
                              id.vars = names( Filter(is.factor, df_tmp_pre) )
                              ) %>%
    group_by(id, variable) %>%
    dplyr::summarise(
      mean_bdc = mean(value, na.rm = T) 
    )
  df_tmp_pre <- reshape2::dcast( df_tmp_pre, id ~ variable, value.var = "mean_bdc") %>%
    rename_at(vars(contains("_z")), ~ str_c("pre_", .))
  df_tmp <- merge(df_tmp_pre, df_tmp, by = c("id") )
  droplevels(df_tmp)
  df_tmp <- merge(df_demo[c(1,3,5:6)], df_tmp, by  = c("id"))
}


# Wrapper for mixed models, takes 'dvList', requires 'model_mm', e.g., model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " * cond.f", " + (1|id)" )
func_mm_fac_with_bdc_adj_help <- function(dvList) {
  map(dvList, function(i) {
    lmerTest::lmer(paste0(i, " ~ pre_", i, model_mm),
                   REML = T,
                   data = df_tmp)
   }) %>% setNames(dvList) #add dvList names
}

# Function for creating mixed model tables, takes 'dvList'
func_tbl_aov <- function(x) {
  tbl_mm_fac_aov <- list_df2df(tbl_mm_fac_aov)
  names(tbl_mm_fac_aov)[4] <- "df1"
  names(tbl_mm_fac_aov)[5] <- "df2"
  names(tbl_mm_fac_aov)[6] <- "F"
  names(tbl_mm_fac_aov)[7] <- "P"
  tbl_mm_fac_aov[c(5:6)] <- round(tbl_mm_fac_aov[c(5:6)], digits = 2) # Round
  tbl_mm_fac_aov[c(7)] <- round(tbl_mm_fac_aov[c(7)], digits = 3) # Round
  return(tbl_mm_fac_aov)
}

# Function emmeans, takes 'dvList'; requires to define 'model', e.g., model <- c(~ time.f * group_3 * cond.f); also requires 'func_mm_fac_with_bdc_adj_help'
func_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite"))
  emm_fac_ <- lapply(emm_fac, data.frame)
  table_emm_fac_df <- ldply(emm_fac_, data.frame) #create df
  table_emm_fac_df_raw <- table_emm_fac_df
  table_emm_fac_df_raw$.id <- as.factor(as.character(table_emm_fac_df_raw$.id ))
  rm(emm_fac_)
  return(table_emm_fac_df_raw)
}

# Helper function contrasts emmeans, takes 'dvList'; also requires 'func_mm_fac_with_bdc_adj_help'
func_contrasts_emm_fac_with_bdc_adj <- function(x) {
  mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
  emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite"))
  contrasts_mm_fac <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, contrast_type,
                                                                         by = factors,
                                                                         lmer.df = "satterthwaite",
                                                                         adjust = "fdr"))
  contrasts_mm_fac <- lapply(contrasts_mm_fac, summary, infer=T) #add adj confidence intervals (adjusted if adjustment method is selected: https://cran.r-project.org/web/packages/emmeans/vignettes/confidence-intervals.html)
  contrasts_mm_fac_ <- lapply(contrasts_mm_fac, data.frame) #create df
  contrasts_mm_fac_df <- ldply(contrasts_mm_fac_, data.frame) #create df
  rm(contrasts_mm_fac_)
  return(contrasts_mm_fac_df)
}

# Function for creating table of contrasts emmeans, takes 'dvList', and requires 'func_contrasts_emm_fac_with_bdc_adj'
func_tbl_contr_emm_fac_with_bdc_adj <- function(dvList) {
  tmp <- func_contrasts_emm_fac_with_bdc_adj(dvList)
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3) #round
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$estimate," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P (unadjusted)"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"
  return(tmp)
}
```
#Functions tables
```{r functions for flextable}
theme_tableflex_report <- function(x, ...) {
  std_b <- fp_border(width = 1.5, color = "black")
  thin_b <- fp_border(width = 0.5, color = "black")
    x <- border_remove(x)
    x <- hline(x, border = thin_b, part = "all")
    x <- hline_top(x, border = std_b, part = "header")
    x <- hline_bottom(x, border = std_b, part = "header")
    x <- hline_bottom(x, border = std_b, part = "body")
    x <- bold(x = x, bold = TRUE, part = "header")
    x <- align_text_col(x, align = "left", header = TRUE)
    x <- align_nottext_col(x, align = "center", header = TRUE)
    fix_border_issues(x)
    autofit(x)
}

set_flextable_defaults(
  font.size = 10,
  font.family = "Times New Roman",
  theme_fun = theme_tableflex_report)
  #padding = 6)
  #background.color = "#EFEFEF")
```
#Themes for Plots
```{r create themes and correction factors new}
# Correct ggplot2 pts and fonts
ggplot_factor_line <- ggplot2::.pt*72.27/96
ggplot_factor_font = 1.0

# Create project report theme
theme_report <- function(base_size = 8) {
  theme_pubr() + #%+replace%
    theme(
      plot.margin = margin(0, 0, 0, 0, "cm"),
      text = element_text(size = 8,
                      colour="black"), #family="Helvetica"
      # axes
      axis.title = element_text(size = 8, face = "bold"), #vjust = 0.5
      axis.text = element_text(size = 8), #angle = 0
      axis.line = element_line(size = 0.5 / ggplot_factor_line, color="black"),
      axis.ticks = element_line(size = 0.5 / ggplot_factor_line, color="black"),
      axis.ticks.length = unit(0.2, "cm"), 
      # legend
      legend.key = element_rect(fill = "transparent", colour = NA),
      legend.key.size = unit(1.5, "lines"),
      legend.background = element_rect(fill = "transparent", colour = NA),
      legend.title = element_blank(),
      legend.text = element_text(size = 8),
      axis.title.x = element_text(size = 8),
      # facetting
      strip.placement = "outside",
          strip.background = element_rect(color = "transparent",
                                          fill = "transparent", size = 1.5),
                                          #linetype = "solid"),
          strip.text = element_text(size = 8,
                                    color = "black",
                                    face = "bold"),
          panel.spacing.y = unit(1.5, "lines")
    )
}

```
#Functions Plotting
```{r functions for plots new}
# Wrapper function for line plots, forwards to func_plot_line_facet
func_plot_line <- function(x) {ggplot(x, tmpaes_plot) + 
    theme_report() +
    geom_line(position = pd,
              size = 0.3) +
    geom_errorbar(tmpaes_errorbar,
                  width =.4,
                  size = 0.3,
                  position = pd) +
    geom_point(position = pd,
               #shape = 21,
               size = 2) +
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "Time", size = 10)
    #scale_shape_manual(values=c(3, 16, 17))+
  }

# Function for line plots, takes 'desc' as input
func_plot_line_facet <- function(x) {func_plot_line(x) +
    facet_grid_def
}


# Function for bar plots, forwards to func_plot_bar_facet
func_plot_bar <- function(x) {ggplot(x, tmpaes_plot) + theme_report() +
    geom_hline(yintercept = 0,
               size = 0.3,
               linetype = "solid") +
    geom_errorbar(tmpaes_errorbar,
                 width = .4,
                  position = pd,
                  color = "black") +
    geom_bar(tmpaes_geombar, # separate by category
             stat = "identity", 
             position = pd,
             width = 1.0,
             color = "black") + # make it side-by-side
    scale_y_continuous(expand = c(0,0)) +
    labs(y = "", x = "", size = 10) +
    guides(x = "none")
}

# Function for bar plots, takes 'desc*' as input
func_plot_bar_facet <- function(x) {func_plot_bar(x) +
    facet_grid_def
}
```
##Load Data
```{r load data}
# Demographics
df_demo <- read_excel("./Data/Data Demographics.xlsx",sheet = "Data Demo")
df_demo[c(1:5)] <- lapply(df_demo[c(1:5)], as.factor)

# Blood
df_blood_morn <- read_excel("./Data/Data Biomarker.xlsx", sheet = "Data Blood Morning z")
df_blood_morn[c(1:2,4)] <- lapply(df_blood_morn[c(1:2,4)], as.factor)
df_blood_morn[c(3, 5:11)] <- lapply(df_blood_morn[c(3, 5:11)], as.numeric)
names(df_blood_morn)[names(df_blood_morn) == "tod"] <- "cond.f"

df_blood_postAG <- read_excel("./Data/Data Biomarker.xlsx", sheet = "Data Blood Post AG z")
df_blood_postAG[c(1:2, 4)] <- lapply(df_blood_postAG[c(1:2, 4)], as.factor)
df_blood_postAG[c(3, 5:11)] <- lapply(df_blood_postAG[c(3, 5:11)], as.numeric)
names(df_blood_postAG)[names(df_blood_postAG) == "tod"] <- "cond.f"

# Cortisol
df_cort_morn <- read_excel("./Data/Data Biomarker.xlsx", sheet = "Data Cortisol Morning z")
df_cort_morn[c(1:2,4)] <- lapply(df_cort_morn[c(1:2,4)], as.factor)
names(df_cort_morn)[names(df_cort_morn) == "tod"] <- "cond.f"

df_cort_eve <- read_excel("./Data/Data Biomarker.xlsx", sheet = "Data Cortisol Evening z")
df_cort_eve[c(1:2,4)] <- lapply(df_cort_eve[c(1:2,4)], as.factor)
names(df_cort_eve)[names(df_cort_eve) == "tod"] <- "cond.f"

df_cort_eve <- df_cort_eve %>%  filter(cort_z < 6)


```
# Data Completion Check
```{r descriptive summaries for completed (missing) data}
# Blood
N_tot <- 24
missing_blood_morn <- func_data_completion(df_blood_morn) 

N_tot <- 16
missing_blood_postAG <- func_data_completion(df_blood_postAG) 

# Cortisol
N_tot <- 24
missing_cortisol_morn <- func_data_completion(df_cort_morn) 
missing_cortisol_morn <- missing_cortisol_morn[2,]

missing_cortisol_eve <- func_data_completion(df_cort_eve) 
missing_cortisol_eve <- missing_cortisol_eve[2,]

# Combine summary
biomarker_summary <- bind_rows(missing_blood_morn, 
                              missing_blood_postAG, 
                              missing_cortisol_morn,
                              missing_cortisol_eve) 

# Sort 
biomarker_summary$variable <- as.character(biomarker_summary$variable)
biomarker_summary <- biomarker_summary[order(biomarker_summary$variable),] 
biomarker_summary <- biomarker_summary[c(1:2, 13:14, 9:10, 5:8, 11:12, 15:16, 3:4),]

# Total summary
biomarker_summary_total <- biomarker_summary %>%
  dplyr::summarise(
    N = sum(N),
    n = sum(n),
    Percent = round(mean(Percent),1)
    )

biomarker_summary$Parameter <- c("BDNF", "" ,
                           "IGF-1", "",
                           "VEGF", "",
                           "NF-L", "",
                           "Il-1b", "",
                           "Il-6", "",
                           "TNFa", "",
                           "Saliva Cortisol", ""
)

biomarker_summary$time_of_day <- c(rep( c("Morn", "Post AG"), 7) , c("Morn", "Eve"))
biomarker_summary[c(6)] <- lapply(biomarker_summary[c(6)], as.factor)

biomarker_summary <- biomarker_summary[c(5,6,2:4)]
colnames(biomarker_summary)[2] <- "Time of Day"
colnames(biomarker_summary)[3] <- "Expected (N)"
colnames(biomarker_summary)[4] <- "Completed (N)"
colnames(biomarker_summary)[5] <- "Completed (%)"
biomarker_summary <- as.data.frame(biomarker_summary)


```
```{r tab.cap = "Data collection summary Biomarker.", tab.cap.style = "Table Caption", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
biomarker_summary <- biomarker_summary %>% flextable() %>% autofit() %>% 
  colformat_double(j = c("Completed (%)"), digits = 1) 
# Print
biomarker_summary
```
# Blood AG
##Mixed Model AG x Time x Group Interaction 
```{r mixed model for AG x group x time blood}
# Extract data collected before and after AG
df_blood_morn_hdt <- subset(df_blood_morn, time.n > 2 & time.n < 8)
df_blood_morn_hdt <- merge(df_demo[c(1,3:6)], df_blood_morn_hdt)
df_blood_morn_hdt <- subset(df_blood_morn_hdt, group_2 == "AG")
df_blood_morn_hdt <- droplevels(df_blood_morn_hdt)[-c(2:5)]
df_blood_morn_hdt <- as_tibble(df_blood_morn_hdt)

# Combine dfs
df_blood_AG <- rbind(df_blood_morn_hdt, df_blood_postAG)
      
# Add baseline as cov
df_blood_morn_ag <- merge(df_demo[c(1,3:6)], df_blood_morn)
df_blood_morn_ag <- subset(df_blood_morn_ag, group_2 == "AG" & time.n < 3)
df_blood_morn_ag <- droplevels(df_blood_morn_ag)
df_blood_morn_ag <- as_tibble(df_blood_morn_ag)

df_blood_pre <- reshape2::melt(df_blood_morn_ag[-c(5,7)], id.vars = names( Filter(is.factor, df_blood_morn_ag) ) )
df_blood_pre <- df_blood_pre %>%
  group_by(id, variable) %>%
  dplyr::summarise(
      value = (value[time.f == "BDC-3"] + value[time.f == "BDC-6"]) / 2
      ) 
df_blood_pre <- reshape2::dcast( df_blood_pre, id ~ variable, value.var = "value")  %>% 
  rename_at(vars(contains("_z")), ~ str_c("pre_", .)) 

# Combine with df_blood_AG
df_blood_AG <- merge(df_blood_AG, df_blood_pre, by = "id")

# Add Demo
df_tmp <- merge(df_demo[c(1,3,4:6)], df_blood_AG, by  = c("id"))

# Select dep vars
dvList <- names(df_tmp[c(9:15)])

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " * cond.f", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "AG",
  "Time x Group",
  "Time x AG",
  "Group x AG",
  "Time x Group x AG"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("BDNF", blanks,"IGF-1", blanks, "Il-1b", blanks, "Il-6", blanks, "NF-L", blanks, "TNFa", blanks, "VEGF", blanks)
tbl_mm_fac_aov_df_blood <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])


```
```{r tab.cap = "Mixed Model Summary for Assessing Effect of AG on Biomarkers.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_blood <- tbl_mm_fac_aov_df_blood %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_blood
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time blood}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ cond.f * time.f * group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3", "time.f")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Sort
tbl_contr_emm_fac_df <- tbl_contr_emm_fac_df[order(tbl_contr_emm_fac_df$'.id', 
                           tbl_contr_emm_fac_df$group_3,
                           tbl_contr_emm_fac_df$time.f),]

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * 
  length(levels(tbl_contr_emm_fac_df$group_3)) -1
tmp_n_group <- length(levels(tbl_contr_emm_fac_df$time.f))  - 1


tbl_contr_emm_fac_df$Variable <- c("BDNF", rep("", tmp_n_dvs),
                                   "IGF-1", rep("", tmp_n_dvs),
                                   "Il-1b", rep("", tmp_n_dvs),
                                   "Il-6", rep("", tmp_n_dvs),
                                   "NF-L", rep("", tmp_n_dvs),
                                   "TNFa", rep("", tmp_n_dvs),
                                   "VEGF", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Group <- rep ( c("cAG", rep("", tmp_n_group),
                                          "iAG",rep("", tmp_n_group)),
                                        length(dvList) )

# Table for contrasts
tbl_contr_emm_fac_df_blood_ag <- tbl_contr_emm_fac_df[c(9:10, 4, 8, 5:7)]
colnames(tbl_contr_emm_fac_df_blood_ag)[c(3)] <- "Time"
```
```{r tab.cap = "Mixed Model Group Contrasts for Assessing Effect of AG on Biomarkers.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_blood_ag <- tbl_contr_emm_fac_df_blood_ag %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (unadjusted)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_blood_ag
```
##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time blood ag}
model_emmeans <- ~ cond.f * time.f * group_3

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3", "time.f")

# Define model for emmeans
model_emmeans <- ~ time.f * group_3 * cond.f

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Add new factor combing groug and cond
emm_fac$cond.f_comb <- paste(emm_fac$group_3, emm_fac$cond.f, sep="_")

# Plot emmeans 
# New facet label names for variable
new_labels <- c("BDNF","IGF-1","Il-1b", "Il-6", "NF-L", "TNFa", "VEGF") 
names(new_labels) <- c("bdnf_z","igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z")

new_labels2 <- c("Before AG", "After AG")
names(new_labels2) <- c("1", "2")

# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = cond.f_comb,
                   fill = cond.f_comb,
                   color = cond.f_comb)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)


# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(.id ~.,
                             switch = "y",
                             labeller = labeller_def,
                             scales = "free") 


# Draw plot
pd <- position_dodge(0.3)
p.blood_ag_emmeans <- func_plot_line_facet(emm_fac %>%
                                        mutate(time.f = fct_relevel(time.f, "HDT2", "HDT14", "HDT30", "HDT42", "HDT56"),
                                               group_3 = fct_relevel(group_3, "cAG", "iAG"),
                                               .id = fct_relevel(.id, "bdnf_z","igf_z", "vegf_z", "nfl_z", "il1b_z", "il6_z", "tnfa_z")
                                               )
                                        )


# Add zero line
p.blood_ag_emmeans <- p.blood_ag_emmeans + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.blood_ag_emmeans <- p.blood_ag_emmeans + theme(legend.key.size = unit(0.3, "cm"))

# Change color
p.blood_ag_emmeans <- p.blood_ag_emmeans + scale_color_brewer(palette = "Paired", limits = c("cAG_1", "cAG_2", "iAG_1", "iAG_2"), labels = c("cAG Pre", "cAG Post", "iAG Pre", "iAG Post")) + scale_fill_brewer(palette = "Paired", limits = c("cAG_1", "cAG_2", "iAG_1", "iAG_2"), labels = c("cAG Pre", "cAG Post", "iAG Pre", "iAG Post"))
```
##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group blood ag}
# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " * cond.f", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- sapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simplify = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group",
  "AG",
  "Group x AG"),
                 length(dvList))
}

# Add variables
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / length(dvList) - 1)
Variable <- c("BDNF", blanks,"IGF-1", blanks, "Il-1b", blanks, "Il-6", blanks, "NF-L", blanks, "TNFa", blanks, "VEGF", blanks)
tbl_mm_fac_aov_df_blood_ag_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of AG on Biomarkers.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_blood_ag_main <- tbl_mm_fac_aov_df_blood_ag_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_blood_ag_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups blood_ag}
# Define model for emmeans
model_emmeans <- ~ group_3 * cond.f

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3 * cond.f

# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3")

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * length(dvList) -1
tmp_n_cond <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) * 
  length(levels(tbl_contr_emm_fac_df$group_3)) -1
tmp_n_group <- length(levels(tbl_contr_emm_fac_df$time.f))  - 1


tbl_contr_emm_fac_df$Variable <- c("BDNF", rep("", 1),
                                   "IGF-1", rep("", 1),
                                   "Il-1b", rep("", 1),
                                   "Il-6", rep("", 1),
                                   "NF-L", rep("", 1),
                                   "TNFa", rep("", 1),
                                   "VEGF", rep("", 1))

colnames(tbl_contr_emm_fac_df)[c(3)] <- "Group"

# Table for contrasts
tbl_contr_emm_fac_blood_ag_main <- tbl_contr_emm_fac_df[c(8,3,7,4:6)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for Main Effect of AG.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_blood_ag_main <- tbl_contr_emm_fac_blood_ag_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (unadjusted)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_blood_ag_main
```
##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups blood_ag}
# Add new factor combing groug and cond
emm_fac$cond.f_comb <- paste(emm_fac$group_3, emm_fac$cond.f, sep="_")

# New facet label names for variable
new_labels <- c("BDNF","IGF-1","Il-1b", "Il-6", "NF-L", "TNFa", "VEGF") 
names(new_labels) <- c("bdnf_z","igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z")

new_labels2 <- c("Before AG", "After AG")
names(new_labels2) <- c("1", "2")

# Define aes for func_plot
tmpaes_plot <- aes(x = cond.f_comb,
                   y = emmean,
                   group = cond.f_comb,
                   fill = cond.f_comb,
                   color = cond.f_comb)

tmpaes_errorbar <- aes(x = cond.f_comb,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = cond.f_comb,
                    y = emmean, 
                    fill = cond.f_comb)

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

facet_grid_def <- facet_grid(.id ~ .,
                             switch = "y",
                             scales = "fixed",
                             labeller = labeller_def) 

# Draw Plot 
pd <- position_dodge(0.99)
p.blood_ag_emmeans_main <- func_plot_bar_facet(emm_fac %>%
  mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"),
         .id = fct_relevel(.id, "bdnf_z","igf_z", "vegf_z", "nfl_z", "il1b_z", "il6_z", "tnfa_z")
         )
  )

# Add zero line
p.blood_ag_emmeans_main <- p.blood_ag_emmeans_main + geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")
                                           
# Adjust legend size
p.blood_ag_emmeans_main <- p.blood_ag_emmeans_main + theme(legend.key.size = unit(0.3, "cm"))

# Change color
p.blood_ag_emmeans_main <- p.blood_ag_emmeans_main + scale_color_brewer(palette = "Paired", limits = c("cAG_1", "cAG_2", "iAG_1", "iAG_2"), labels = c("cAG Pre", "cAG Post", "iAG Pre", "iAG Post")) + scale_fill_brewer(palette = "Paired", limits = c("cAG_1", "cAG_2", "iAG_1", "iAG_2"), labels = c("cAG Pre", "cAG Post", "iAG Pre", "iAG Post")) 
```
##Create Combined plot 
```{r plot combined blood_ag}
# Combine plot 
p.blood_ag_comb <- plot_grid(p.blood_ag_emmeans, p.blood_ag_emmeans_main + rremove("x.text") +
                          theme( strip.text.y = element_blank() ),
                        labels = c("", ""), label_size =10,
                        ncol = 2, nrow = 1,
                        rel_widths = c(2.3, 0.7))

# Adjust legend size
p.blood_ag_comb <- p.blood_ag_comb + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Biomarker/p.blood_ag_comb.pdf",
    width = 30/2.54, 
    height = 20/2.54,
    useDingbats = FALSE) #in cm
print(p.blood_ag_comb)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 6, fig.height = 8, echo = FALSE, fig.cap = "Biomarker AG: (a) Time course of biomarkers during bed rest. (b) Main effect of bed rest. Data are means and SD adjusted for baseline."}
p.blood_ag_comb
```
# Effect of Bed Rest
```{r prepare biomarker}
# Combine blood and cortisol
colnames(df_cort_morn)[5] <- "cort_morn_z"
colnames(df_cort_eve)[5] <- "cort_eve_z"

df_cort <- merge(df_cort_morn[-c(4)], df_cort_eve[-c(4)], by = c("id", "time.f", "time.n"))
df_bio <- merge(df_blood_morn[-c(4)], df_cort, by = c("id", "time.f", "time.n"))

# Add baseline as cov
#df_bio_pre <- subset(df_bio, time.n < 3)
#df_bio_pre <- reshape2::melt(df_bio_pre[-c(3)], id.vars = names( Filter(is.factor, df_bio_pre) ) )
#df_bio_pre <- df_bio_pre %>%
#  group_by(id, variable) %>%
#  dplyr::summarise(
#      value = (value[time.f == "BDC-3"] + value[time.f == "BDC-6"]) / 2
#      ) 
#df_bio_pre <- reshape2::dcast( df_bio_pre, id ~ variable, value.var = "value")  %>% 
#  rename_at(vars(contains("_z")), ~ str_c("pre_", .)) 

#df_bio <- merge(df_bio, df_bio_pre, by ="id")
```
#Plot Time Course adjusted for Baseline 
```{r plot time course adjusted for baseline}
# Compute desc
desc <- func_desc(df_bio[-c(3)], group_3, time.f, variable)

# Shift mean within groups to reflect a pre-HDT baseline performance of 0 (zero) (To reflect the analytical approach (adjusting for baseline performance).
desc <- func_bdc_correction(desc)

# Plot 
# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = MEAN,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = MEAN-SE, 
                    ymax = MEAN+SE)

# Define positioning
pd <- position_dodge(0.3)

# Speed
# Select
#desc <- dplyr::filter(desc_all, grepl("AvR", variable))
#desc <- droplevels(desc)
# New facet label names for variable

new_labels <- c("BDNF","IGF-1","Il-1b", "Il-6", "NF-L", "TNFa", "VEGF", "Cortisol Morn", "Cortisol Eve") 
names(new_labels) <- c("bdnf_z","igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z", "cort_morn_z","cort_eve_z")

# Define labels for func_plot_line_facet
labeller_def <- labeller(variable = new_labels)

facet_grid_def <- facet_wrap(~ variable,
                             switch = "y",
                             ncol = 1,
                             labeller = labeller_def,
                             scales = "free") 

# Draw plot
p.bio_desc <- func_plot_line_facet(desc %>%
                                                 mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")) %>%
  mutate(time.f = fct_relevel(time.f, "BDC-6", "BDC-3", "HDT2", "HDT14", "HDT30","HDT42", "HDT56", "R+1", "R+10"))) +
  geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.bio_desc <- p.bio_desc + theme(legend.key.size = unit(0.3, "cm"))



p.bio_desc_1 <- func_plot_line_facet( subset( desc, variable == "il1b_z" | variable == "il6_z" | variable == "tnfa_z" | variable == "cort_morn_z" | variable == "cort_eve_z") %>% mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG")) %>%
  mutate(time.f = fct_relevel(time.f, "BDC-6", "BDC-3", "HDT2", "HDT14", "HDT30","HDT42", "HDT56", "R+1", "R+10"), variable = fct_relevel(variable, "il1b_z", "il6_z", "tnfa_z", "cort_morn_z", "cort_eve_z"))) +
  geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.bio_desc_1 <- p.bio_desc_1 + theme(legend.key.size = unit(0.3, "cm"))

p.bio_desc_2 <- func_plot_line_facet(subset( desc, variable != "il1b_z" & variable != "il6_z" & variable != "tnfa_z" & variable != "cort_morn_z" & variable != "cort_eve_z") %>%
  mutate(time.f = fct_relevel(time.f, "BDC-6", "BDC-3", "HDT2", "HDT14", "HDT30","HDT42", "HDT56", "R+1", "R+10"),
         variable = fct_relevel(variable, "bdnf_z","igf_z", "vegf_z", "nfl_z"))) +
  geom_hline(yintercept = 0, size = 0.3, linetype = "dotted")

# Adjust legend size
p.bio_desc_2 <- p.bio_desc_2 + theme(legend.key.size = unit(0.3, "cm"))
```
##Mixed Model Time x Group Interaction 
```{r mixed model for time x group Cognition}
# Define BDC sessions (number indicates last bdc sessions based on time.n)
bdc <- 2

# Create df with bdc as covariate
df_tmp <- func_bdc_cov_multi_sep(df_bio, id)

# Select dep vars

dvList <- colnames(df_tmp)[c(16:24)]

# Define model
model_mm <- paste0(" + sex"," + age", " + time.f",  " * group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- lapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simply = FALSE, USE.NAMES = TRUE) 

# ANOVA table 
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Time",
  "Group",
  "Time x Group"),
                 length(dvList)/3)
}

# Create parameters
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / ( length(dvList) / 3) - 1)
Variable <- c("BDNF", blanks,"IGF-1", blanks, "Il-1b", blanks, "Il-6", blanks, "NF-L", blanks, "TNFa", blanks, "VEGF", blanks, "Cortisol Morn", blanks, "Cortisol Eve", blanks)

# Add to parameters to tables
tbl_mm_fac_aov_df_bio <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary for Biomarker.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_bio <- tbl_mm_fac_aov_df_bio %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_bio
```
##Contrasts for Comparing Groups at Each Time Point During Bed Rest
```{r contrasts for groups by time}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c("time.f")

dvList <- c("bdnf_z", "igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z", "cort_morn_z", "cort_eve_z" )

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList %>% 
                                       mutate(time.f = fct_relevel(time.f, "BDC-6", "BDC-3", "HDT2", "HDT14", "HDT30","HDT42", "HDT56", "R+1", "R+10"))) 

# Create vars to make nice table
tmp_n_dvs <- length(levels(tbl_contr_emm_fac_df$Contrast)) * 
  length(levels(tbl_contr_emm_fac_df$time.f)) -1

tmp_n_time <- length(levels(tbl_contr_emm_fac_df$Contrast)) - 1

tbl_contr_emm_fac_df$Variable <- c("BDNF", rep("", tmp_n_dvs),
                                   "IGF-1", rep("", tmp_n_dvs),
                                   "Il-1b", rep("", tmp_n_dvs),
                                   "Il-6", rep("", tmp_n_dvs),
                                   "NF-L", rep("", tmp_n_dvs),
                                   "TNFa", rep("", tmp_n_dvs),
                                   "VEGF", rep("", tmp_n_dvs),
                                   "Cort Morn", rep("", tmp_n_dvs),
                                   "Cort Eve", rep("", tmp_n_dvs))

tbl_contr_emm_fac_df$Time <- rep ( c("HDT2", rep("", tmp_n_time),
                                     "HDT14", rep("", tmp_n_time),
                                     "HDT30", rep("", tmp_n_time),
                                     "HDT42", rep("", tmp_n_time),
                                     "HDT56", rep("", tmp_n_time),
                                     "R+1", rep("", tmp_n_time),
                                     "R+10", rep("", tmp_n_time)),
                                   length(dvList)/3 )

# Add to parameters to tables
tbl_contr_emm_fac_df <- tbl_contr_emm_fac_df[c(8:9, 2, 7, 4:6)]
```
```{r tab.cap = "Mixed Model Group Contrasts for Biomarkers.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df <- tbl_contr_emm_fac_df %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (unadjusted)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df
```
##Contrasts for Comparing Time Points During Bed Rest
```{r contrasts for groups by group}
# Contrasts
# Define model for contrasts
model_emmeans <- ~ time.f * group_3
model_emmeans <- ~ time.f
# Define contrasts
contrast_type <- "trt.vs.ctrl"
factors <- c("group_3")
factors <- c()

dvList <- c("bdnf_z", "igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z", "cort_morn_z", "cort_eve_z" )

# Run contrasts
mm_fac <- func_mm_fac_with_bdc_adj_help(dvList)
emm_fac <- lapply(mm_fac, function(mm_fac) emmeans::emmeans(mm_fac, model_emmeans, lmer.df = "satterthwaite"))
contrasts_mm_fac <- lapply(emm_fac, function(emm_fac) contrast(emm_fac, "trt.vs.ctrl", ref = "HDT2",
                                                                         by = factors,
                                                                         lmer.df = "satterthwaite",
                                                                         adjust = "fdr"))
contrasts_mm_fac <- lapply(contrasts_mm_fac, summary, infer=T) #add adj confidence intervals (adjusted if adjustment method is selected: https://cran.r-project.org/web/packages/emmeans/vignettes/confidence-intervals.html)
contrasts_mm_fac_ <- lapply(contrasts_mm_fac, data.frame) #create df
contrasts_mm_fac_df <- ldply(contrasts_mm_fac_, data.frame) #create df
tmp <- contrasts_mm_fac_df
  tmp[ncol(tmp)] <- round(tmp[ncol(tmp)], digits = 3) #round
  tmp[ncol(tmp)-1] <- round(tmp[ncol(tmp)-1], digits = 2) #round
  tmp[ncol(tmp)-2] <- round(tmp[ncol(tmp)-2], digits = 2) #round
  tmp[ncol(tmp)-3] <- round(tmp[ncol(tmp)-3], digits = 2) #round
  tmp[ncol(tmp)-4] <- round(tmp[ncol(tmp)-4], digits = 1) #round
  tmp[ncol(tmp)-5] <- round(tmp[ncol(tmp)-5], digits = 2) #round
  tmp[ncol(tmp)-6] <- round(tmp[ncol(tmp)-6], digits = 2) #round
  tmp$CI <- paste0("(",tmp$lower.CL,"," ,tmp$upper.CL,")")
  tmp$CI <- gsub( ",", ", ", tmp$CI ) 
  tmp$CI <- paste0(tmp$estimate," " ,tmp$CI)
  tmp <- tmp[-c(ncol(tmp)-3,
                ncol(tmp)-4,
                ncol(tmp)-6,
                ncol(tmp)-7)]
  colnames(tmp)[ncol(tmp)] <- "Mean (95%CI)"
  colnames(tmp)[ncol(tmp)-1] <- "P (unadjusted)"
  colnames(tmp)[ncol(tmp)-2] <- "t"
  colnames(tmp)[2] <- "Contrast"  

tbl_contr_emm_fac_df <- tmp
# Create vars to make nice table

tbl_contr_emm_fac_df$Variable <- c("BDNF", rep("", 5),
                                   "IGF-1", rep("", 5),
                                   "Il-1b", rep("", 5),
                                   "Il-6", rep("", 5),
                                   "NF-L", rep("", 5),
                                   "TNFa", rep("", 5),
                                   "VEGF", rep("", 5),
                                   "Cort Morn", rep("", 5),
                                   "Cort Eve", rep("", 5))

# Add to parameters to tables
tbl_contr_emm_fac_df <- tbl_contr_emm_fac_df[c(7,2,6,3:5)]

```
```{r tab.cap = "Mixed Model Contrasts for Time Effect Across Groups for Cognition Speed.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df <- tbl_contr_emm_fac_df %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (unadjusted)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df
```

##Plot Estimated Marignal Means To Show Time Course for Each Group
```{r plot emmeans for groups by time}
# Define model for emmeans
model_emmeans <- ~ time.f * group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList) 

# Plot emmeans 
# Define aes for func_plot
tmpaes_plot <- aes(x = time.f, y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = time.f,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

# Draw plot
pd <- position_dodge(0.3)

# New facet label names for variable
new_labels <- c("BDNF","IGF-1","Il-1b", "Il-6", "NF-L", "TNFa", "VEGF", "Cortisol Morn", "Cortisol Eve") 
names(new_labels) <- c("bdnf_z","igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z", "cort_morn_z","cort_eve_z")

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

# Define grid
facet_grid_def <- facet_wrap(~ .id,
                             switch = "y",
                             ncol = 1,
                             labeller = labeller_def) 

# Plot
p.bio_emmeans <- func_plot_line_facet(emm_fac %>%
                                                  mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"),
                                                         .id = fct_relevel(.id, "bdnf_z","igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z")))+ geom_hline(yintercept = 0, size = 0.3, linetype = "dotted") + theme(legend.key.size = unit(0.3, "cm"))
```

##Mixed Model for Main Effect of Bed Rest (excluding BDC)
```{r mixed model for main effect group}
# Select HDBR data
# Drop Recovery
df_tmp <- subset(df_tmp, time.n < 8)
df_tmp <- droplevels(df_tmp)

# Select dep vars
dvList <- colnames(df_tmp)[c(16:24)]

# Define model
model_mm <- paste0(" + sex"," + age", " + group_3", " + (1|id)" )

# Run mixed models
tbl_mm_fac_aov <- lapply(func_mm_fac_with_bdc_adj_help(dvList), anova, simply = FALSE, USE.NAMES = TRUE) 

# ANOVA table
tbl_mm_fac_aov_df <- func_tbl_aov(dvList)

# Helper functions for parameter definition in mixed model tables, takes 'dvList'
Parameter_func <- function(dvList){
  rep(c(
  "Baseline",
  "Sex",
  "Age",
  "Group"),
                 length(dvList)/3)
}

# Add variables
# Create parameters
Parameter <- Parameter_func(dvList)
blanks <- rep("", length(Parameter) / ( length(dvList)/3 ) - 1)
Variable <- c("BDNF", blanks,"IGF-1", blanks, "Il-1b", blanks, "Il-6", blanks, "NF-L", blanks, "TNFa", blanks, "VEGF", blanks, "Cortisol Morn", blanks, "Cortisol Eve", blanks)

# Add to parameters to tables
tbl_mm_fac_aov_df_bio_main <- cbind(Variable, Parameter, tbl_mm_fac_aov_df[c(4:7)])
```
```{r tab.cap = "Mixed Model Summary testing the Main Effect of Group for Biomarker.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_mm_fac_aov_df_bio_main <- tbl_mm_fac_aov_df_bio_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df2", "F"), digits = 1) %>% 
  colformat_double( j = c("P"), digits = 3 ) 
# Print
tbl_mm_fac_aov_df_bio_main
```
##Contrasts for Comparing Groups
```{r contrasts for groups}
# Define model for emmeans
model_emmeans <- ~ group_3

# Run emmeans
emm_fac <- func_emm_fac_with_bdc_adj(dvList)

# Contrasts
# Define model for contrasts
model_emmeans <- ~ group_3

# Define contrasts
contrast_type <- "pairwise"
factors <- c()

# Run contrasts
tbl_contr_emm_fac_df <- func_tbl_contr_emm_fac_with_bdc_adj(dvList)

# Add variables
# Create vars to make nice table
tbl_contr_emm_fac_df$Variable <- c("BDNF", rep("", 2),
                                   "IGF-1", rep("", 2),
                                   "Il-1b", rep("", 2),
                                   "Il-6", rep("", 2),
                                   "NF-L", rep("", 2),
                                   "TNFa", rep("", 2),
                                   "VEGF", rep("", 2),
                                   "Cort Morn", rep("", 2),
                                   "Cort Eve", rep("", 2))

# Add to parameters to tables
tbl_contr_emm_fac_df_bio_main <- tbl_contr_emm_fac_df[c(7, 2,6, 3:5)]
```
```{r tab.cap = "Mixed Model Contrasts Comparing Groups for Biomarker.", tab.topcaption = TRUE, echo = FALSE}
# Convert to word flextable
tbl_contr_emm_fac_df_bio_main <- tbl_contr_emm_fac_df_bio_main %>% flextable() %>% autofit() %>% 
  colformat_double( j = c("df", "t"), digits = 1) %>% 
  colformat_double( j = c("P (unadjusted)"), digits = 3 ) 
# Print
tbl_contr_emm_fac_df_bio_main
```
##Plot Estimated Marignal Means for Comparing Groups
```{r plot groups}
# Define aes for func_plot
tmpaes_plot <- aes(x = contrast,
                   y = emmean,
                   group = group_3,
                   fill = group_3,
                   color = group_3)

tmpaes_errorbar <- aes(x = group_3,
                    ymin = emmean-SE, 
                    ymax = emmean+SE)

tmpaes_geombar <- aes(x = group_3,
                    y = emmean, 
                    fill=group_3)

# Positioning
pd <- position_dodge(0.99)

# New facet label names for variable
new_labels <- c("BDNF","IGF-1","Il-1b", "Il-6", "NF-L", "TNFa", "VEGF", "Cortisol Morn", "Cortisol Eve") 
names(new_labels) <- c("bdnf_z","igf_z", "il1b_z", "il6_z", "nfl_z", "tnfa_z", "vegf_z", "cort_morn_z","cort_eve_z")

# Define labels for func_plot_line_facet
labeller_def <- labeller(.id = new_labels)

# Define grid
facet_grid_def <- facet_wrap(~ .id,
                             switch = "y",
                             ncol = 1,
                             labeller = labeller_def) 

# Draw Plot 
p.bio_emmeans_main <- func_plot_bar_facet(emm_fac %>%
                                                  mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"),
                                                         .id = fct_relevel(.id, "bdnf_z","igf_z", "vegf_z", "nfl_z", "il1b_z", "il6_z", "tnfa_z", "cort_morn_z", "cort_eve_z"))) + theme(legend.key.size = unit(0.3, "cm"))

# Draw Plot 
p.bio_emmeans_main_1 <- func_plot_bar_facet(subset( emm_fac, .id == "il1b_z" | .id == "il6_z" | .id == "tnfa_z" | .id == "cort_morn_z" | .id == "cort_eve_z") %>%
                                                  mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"),
                                                         .id = fct_relevel(.id, "il1b_z", "il6_z", "tnfa_z", "cort_morn_z", "cort_eve_z"))) + theme(legend.key.size = unit(0.3, "cm"))

p.bio_emmeans_main_2 <- func_plot_bar_facet(subset( emm_fac, .id != "il1b_z" & .id != "il6_z" & .id != "tnfa_z" & .id != "cort_morn_z" & .id != "cort_eve_z") %>%
                                                  mutate(group_3 = fct_relevel(group_3, "CTRL", "cAG", "iAG"),
                                                         .id = fct_relevel(.id, "bdnf_z","igf_z", "vegf_z", "nfl_z"))) + theme(legend.key.size = unit(0.3, "cm"))
```
##Create Combined plot Biomarker
```{r plot combined biomarker}
# Combine plot 
p.bio_comb_1 <- plot_grid(p.bio_desc_1,
                                  p.bio_emmeans_main_1 + rremove("x.text") + theme( strip.text.y = element_blank() ),
                                  labels = c("a", "b"), label_size =10,
                                  ncol = 2, nrow = 1, rel_widths = c(2.4, 0.6)
                                  )
# Adjust legend size
p.bio_comb_1 <- p.bio_comb_1 + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Biomarker/p.bio_comb_1.pdf",
    width = 32/2.54, 
    height = 22/2.54,
    useDingbats=FALSE) #in cm
print(p.bio_comb_1)
dev.off()

p.bio_comb_2 <- plot_grid(p.bio_desc_2,
                                  p.bio_emmeans_main_2 + rremove("x.text") + theme( strip.text.y = element_blank() ),
                                  labels = c("a", "b"),
                                  ncol = 2, nrow = 1, rel_widths = c(2.4, 0.6)
                                  )
# Adjust legend size
p.bio_comb_2 <- p.bio_comb_2 + theme(legend.key.size = unit(0.3, "cm"))

# Save plot as pdf
pdf("./Figures/Biomarker/p.bio_comb_2.pdf",
    width = 32/2.54, 
    height = 22/2.54,
    useDingbats=FALSE) #in cm
print(p.bio_comb_2)
dev.off()
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 6.5, fig.height = 7, echo = FALSE, fig.cap = "Effect of HDBR on Il-1b, Il-6, TNFa, and saliva cortisol. (a) Time course of biomarker before, during, and after bed rest. Means within groups are shifted to reflect a pre-HDT baseline performance of 0 (zero). (b) Main effect of bed rest. Data means and SE are adjusted for baseline. "}
p.bio_comb_1
```
```{r fig.id = "tsplot", fig.cap.style = "Image Caption", fig.width = 6.5, fig.height = 6, echo = FALSE, fig.cap = "Effect of HDBR on BDNF, IGF-1, VEGF, and NF-L. (a) Time course of biomarker before, during, and after bed rest. Means within groups are shifted to reflect a pre-HDT baseline performance of 0 (zero). (b) Main effect of bed rest. Data means and SE are adjusted for baseline. "}
p.bio_comb_2
```
